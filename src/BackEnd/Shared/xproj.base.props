<Project ToolsVersion="__ToolsVersion__" DefaultTargets="Build" xmlns="http://schemas.microsoft.com/developer/msbuild/2003">
  <PropertyGroup>
    <VisualStudioVersion Condition="'$(VisualStudioVersion)' == ''">14.0</VisualStudioVersion>
    <VSToolsPath Condition="'$(VSToolsPath)' == ''">$(MSBuildExtensionsPath32)\Microsoft\VisualStudio\v$(VisualStudioVersion)</VSToolsPath>
  </PropertyGroup>
  <Import Project="$(VSToolsPath)\AspNet\Microsoft.Web.AspNet.Props" Condition="'$(VSToolsPath)' != ''" />
  <PropertyGroup>
    <!-- Cautious: trailing forward slash and backward slash must be eliminated -->
    <BRANCH_ROOT Condition=" '$(BRANCH_ROOT)' == '' ">$([System.IO.Directory]::GetParent($(MSBuildThisFileDirectory)).Parent.FullName)</BRANCH_ROOT>
    <GITPATH Condition=" '$(GIT_ROOT)' == '' ">$(MSBuildProgramFiles32)/Git/cmd/git.exe</GITPATH>
    <ProjectJsonFilePath>$(MSBuildProjectDirectory)/project.json</ProjectJsonFilePath>
    <GlobalReferencePath>$(MSBuildProgramFiles32)/Reference Assemblies/Microsoft/Framework/.NETFramework/$(TargetFrameworkVersion)</GlobalReferencePath>
    <PowerShellExe Condition=" '$(PowerShellExe)'=='' ">%WINDIR%\System32\WindowsPowerShell\v1.0\powershell.exe</PowerShellExe>
    <ScriptPath Condition="'$(ScriptPath)'=='' ">$(MSBuildThisFileDirectory)/XprojUpdateVersion.ps1</ScriptPath>
  </PropertyGroup>
  <UsingTask TaskName="OverwriteXpojVersion" AssemblyFile="XprojVersionCustomTask.dll" />

  <!-- Version information is mandatory -->
  <Target Name="GenerateVersionInfo" BeforeTargets="PrepareForBuild">
    <Exec Command="&quot;$(GITPATH)&quot; describe" ConsoleToMSBuild="true" IgnoreExitCode="true">
      <Output PropertyName="OutputConsoleValue" TaskParameter="ConsoleOutput"/>
      <Output PropertyName="ExecExitCode" TaskParameter="ExitCode"/>
    </Exec>
    <Exec Command="$(PowerShellExe) -NonInteractive -ExecutionPolicy RemoteSigned -Command &quot; &amp; {&amp;&apos;$(ScriptPath)&apos; &apos;$(OutputConsoleValue)&apos; &apos;$(ProjectJsonFilePath)&apos; }&quot;" Condition="$(ExecExitCode) == '0'"  ConsoleToMSBuild="true"  IgnoreExitCode="true">
      <Output PropertyName="ExecExitCode" TaskParameter="ExitCode"/>
      <Output PropertyName="OutputMessage" TaskParameter="ConsoleOutput"/>
    </Exec>
    <Warning Text="$(OutputMessage)" Condition="$(ExecExitCode) != '0'" />
  </Target>

  <ItemGroup>
    <Compile Include="$(BRANCH_ROOT)\TEMP\version.cs" />
  </ItemGroup>
</Project>
