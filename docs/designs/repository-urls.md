# Repository Urls

Explain the 3 types of repository urls used in DocFX and their design purposes and use scenarios.   

*******

## Definitions

| Name                            | Definition                                                                |
|---------------------------------|---------------------------------------------------------------------------|
| Repository Url                  | The url of current build repo, i.e. the argument of `git clone`           |
| Repository Branch               | The branch of current build repo                                          |
| Publish Repository Url          | Optional, the url of OPS provisioned repository                           |
| Publish Repository Branch       | Optional, the branch of OPS provisioned repository                        |
| Pull Request Repository Url     | Optional, it will only present for builds triggered by pull requests      |
| Pull Request Repository Branch  | Optional, it will only present for builds triggered by pull requests      | 
| Contribution Repository         | Public repositories associated with the private provisioned repositories  |


	
*******

## Overview  
The values of **Repository Url**, **Repository Branch**, **Publish Repository Url**, **Publish Repository Branch**, **Pull Request Repository Url** and **Pull Request Repository Branch**  will be passed via one or more the following approaches.
1. DocFX command options
2. environment variables
3. config 

For all DocFX build scenarios, it will always fetch build information via **Publish Repository Url** + **Publish Repository Branch** (then fallback to  **Repository Url** + **Repository Branch**).

**Build Outputs:** 
 1. DHS data   
    Related DHS metadata include _GitCommit_, _ContentGitUrl_, _OriginalContentGitUrl_ and _OriginalContentGitUrlTemplate_  which should be linked to the **Publish Repository Url** (then fallback to  **Repository Url**) because their values will be calculated into file content hash which is used in **incremental publish**.

 2. Report    
    Including html report pages, report emails and PR comments.
    Content authors may click links on report to navigate to the source files to fix content if there is any warning/error/suggestion. e.g. for PR builds, the links should navigate to the PR source repository url.   

    The link urls will be generated from _.publish.json_ **source_url** properties.   

    When constructing **source_url**
    - if it is branch build,  **source_url** is generated by **Repository Url** and **Repository Branch**
    - if it is pull request build, **source_url** is generated by **Pull Request Repository Url** and **Pull Request Repository Branch** 

 3. Telemetry    
    Tracked mostly by Docs.Build.      
    The different build scenarios should use different telemetry metric/log labels or properties to distinguish from each other, which will be handled properly on Docs.Build.    
    For DocFX, it will only track **Repository Url**.
	
*******

## Scenarios:

### Scenario 1: Branch build 
The **Repository Url**, **Publish Repository Url** are exactly the **SAME**. 

But **Pull Request Repository Url** is not present.

Output: 
1. DHS data  -> **Publish Repository Url**
2. Report    -> **Repository Url**
3. Telemetry -> **Repository Url** + **Repository Branch** 


Example:    
DocFX build repo https://github.com/MicrosoftDocs/sql-docs-pr  for branch _main_

|            Name                   |                   Value                         |  Comment                            | 
|-----------------------------------|-------------------------------------------------|-------------------------------------|
| **Publish Repository Url**        |  https://github.com/MicrosoftDocs/sql-docs-pr   |  It is provisioned on OPS.          | 
| **Publish Repository Branch**     |  main                                           |                                     | 
| **Repository Url**                |  https://github.com/MicrosoftDocs/sql-docs-pr   |                                     |
| **Repository Branch**             |  main                                           |                                     |
|**Pull Request Repository Url**    |  Not present                                    |  not triggered by a pull request    |
|**Pull Request Repository Branch** |  Not present                                    |  not triggered by a pull request    |


Output   
|  Type     |              Related Url                                              |
|-----------|-----------------------------------------------------------------------|
| DHS data  | https://github.com/MicrosoftDocs/sql-docs-pr                          |
| Report    | https://github.com/MicrosoftDocs/sql-docs-pr/blob/main/docs/index.yml |
| Telemetry | https://github.com/MicrosoftDocs/sql-docs-pr  +  main                 |


	
*******

### Scenario 2: Pull Request build (PR build)
The **Repository Url** is the same with **Publish Repository Url** which is also the PR target repository url.

The **Pull Request Repository Url** is the PR source repository url which may be the same repository as **Repository Url** or its **forked** repository url.

Output: 
1. DHS data  -> **Publish Repository Url**
2. Report    -> **Pull Request Repository Url**
3. Telemetry -> **Repository Url** + **Repository Branch** 



Example:    
DocFX build pull request from https://github.com/SomeAuthor/sql-docs-pr branch _patch-1_ to https://github.com/MicrosoftDocs/sql-docs-pr  branch _main_

|            Name                   |                   Value                         |  Comment                      | 
|-----------------------------------|-------------------------------------------------|-------------------------------|
| **Publish Repository Url**        |  https://github.com/MicrosoftDocs/sql-docs-pr   |  provisioned on OPS.          | 
| **Publish Repository Branch**     |  main                                           |                               | 
| **Repository Url**                |  https://github.com/MicrosoftDocs/sql-docs-pr   |                               |
| **Repository Branch**             |  pr-en-us-1                                     | passed by Docs.Build          |
|**Pull Request Repository Url**    |  https://github.com/SomeAuthor/sql-docs-pr      | triggered by a pull request   |
|**Pull Request Repository Branch** |  patch-1                                        | triggered by a pull request   |


Output   
|  Type     |              Related Url                                              |
|-----------|-----------------------------------------------------------------------|
| DHS data  | https://github.com/MicrosoftDocs/sql-docs-pr                          |
| Report    | https://github.com/SomeAuthor/sql-docs-pr/blob/patch-1/docs/index.yml |
| Telemetry | https://github.com/MicrosoftDocs/sql-docs-pr  +  pr-en-us-1           |



*******

### Scenario 3: Contribution repo branch build

The **Repository Url** is the different from **Publish Repository Url**.

**Publish Repository Branch** is possibly **different** from **Repository Branch**.

The **Pull Request Repository Url** is not present.

Output: 
1. DHS data  -> **Publish Repository Url**
2. Report    -> **Repository Url**
3. Telemetry -> **Repository Url** + **Repository Branch** 


Example:    
DocFX build repo https://github.com/MicrosoftDocs/sql-docs for branch _main_

Note: https://github.com/MicrosoftDocs/sql-docs is the public contribution repository of https://github.com/MicrosoftDocs/sql-docs-pr which is private.  

|            Name                   |                   Value                         |  Comment                          | 
|-----------------------------------|-------------------------------------------------|-----------------------------------|
| **Publish Repository Url**        |  https://github.com/MicrosoftDocs/sql-docs-pr   |  private provisioned on OPS.      | 
| **Publish Repository Branch**     |  branch1                                        |                                   | 
| **Repository Url**                |  https://github.com/MicrosoftDocs/sql-docs      |  public contribution repository   |
| **Repository Branch**             |  branch2                                        |                                   |
|**Pull Request Repository Url**    |  Not present                                    |  not triggered by a pull request  |
|**Pull Request Repository Branch** |  Not present                                    |  not triggered by a pull request  |


Output   
|  Type     |              Related Url                                              |
|-----------|-----------------------------------------------------------------------|
| DHS data  | https://github.com/MicrosoftDocs/sql-docs-pr                          |
| Report    | https://github.com/MicrosoftDocs/sql-docs/blob/branch2/docs/index.yml |
| Telemetry | https://github.com/MicrosoftDocs/sql-docs  +  branch2                 |


*******

### Scenario 4: Contribution repo PR build 

The **Repository Url** is the different from **Publish Repository Url**.

 The **Repository Url** is the PR target repository url.

The **Pull Request Repository Url** is the PR source repository url which may be the same repository as **Repository Url** or its **forked** repository url.


Output: 
1. DHS data  -> **Publish Repository Url**
2. Report    -> **Pull Request Repository Url**
3. Telemetry -> **Repository Url** + **Repository Branch** 



Example:    
DocFX build pull request from https://github.com/SomeAuthor/sql-docs branch _patch-1_ to https://github.com/MicrosoftDocs/sql-docs  branch _main_   

Note: https://github.com/MicrosoftDocs/sql-docs is the public contribution repository of https://github.com/MicrosoftDocs/sql-docs-pr which is private.   

|            Name                   |                   Value                         |  Comment                        | 
|-----------------------------------|-------------------------------------------------|---------------------------------|
| **Publish Repository Url**        |  https://github.com/MicrosoftDocs/sql-docs-pr   |  private provisioned on OPS.    | 
| **Publish Repository Branch**     |  main                                           |                                 | 
| **Repository Url**                |  https://github.com/MicrosoftDocs/sql-docs      |  public contribution repository |
| **Repository Branch**             |  pr-en-us-2                                     |  passed by Docs.Build           |
|**Pull Request Repository Url**    |  https://github.com/SomeAuthor/sql-docs         |  triggered by a pull request    |
|**Pull Request Repository Branch** |  patch-2                                        |  triggered by a pull request    |


Output   
|  Type     |              Related Url                                           |
|-----------|--------------------------------------------------------------------|
| DHS data  | https://github.com/MicrosoftDocs/sql-docs-pr                       |
| Report    | https://github.com/SomeAuthor/sql-docs/blob/patch-2/docs/index.yml |
| Telemetry | https://github.com/MicrosoftDocs/sql-docs  +  pr-en-us-2           |



*******

## Other Related Topics

### The report links of CRR files will not affected by **Pull Request Repository Url** or **Repository Url**

DocFX will resolve CRR files according to the configuration in _.openpublishing.publish.config.json_ and the links will point the CRR repository url but not affected by **Pull Request Repository Url** or **Repository Url** .
