# Metadata keys are case sensitive
inputs:
  docfx.yml: |
    globalMetadata:
      key: global
      KEY: GLOBAL
  docs/a.md: |
    ---
    key: header
    KEY: HEADER
    ---
outputs:
  docs/a.json: |
    { "key": "header", "KEY": "HEADER" }
---
# Preserve custom metadata
# read-only metadata will be kept as user input, no matter they are known by docfx or not, like uid
# overwritable metadta will be overwritten by docfx when the input is valid, otherwise it's will not be changed
inputs:
  docfx.yml:
  docs/a.md: |
    ---
    ms.custom-metadata:
    uid:
    breadcrumb_path: "/breadcrumb_path"
    author: xxx
    ---
    # Title
outputs:
  docs/a.json: |
    { "ms.custom-metadata": null, "author":"xxx", "uid": null, "breadcrumb_path": "/breadcrumb_path", "title": "Title"}
---
# Overwrite global metadata with null in yaml header
inputs:
  docfx.yml: |
    globalMetadata:
      ms.custom-metadata: not-null
  a.md: |
    ---
    ms.custom-metadata:
    ---
outputs:
  a.json: |
    { "ms.custom-metadata": null }
---
# Report error for invalid yaml header value type
inputs:
  docfx.yml:
  docs/a.md: |
    ---
    title: {}
    ---
outputs:
  .errors.log: |
    ["error","violate-schema","Expected type String, please input String or type compatible with String.","docs/a.md",2,8]
    ["error","invalid-metadata-type","Metadata 'title' can only be a scalar value or string array","docs/a.md",2,8]
---
# Report error for invalid yaml header value type as array
inputs:
  docfx.yml:
  docs/a.md: |
    ---
    author:
      - a
      - b
    ---
outputs:
  .errors.log: |
    ["error","violate-schema","Cannot deserialize the current JSON array *\n*","docs/a.md",3,3]
---
# generate normal document id and version id
# backward compatible to docs.com
# document id = md5("Win.sccm|mdt/release-notes.md")
# version independent id = md5("Win.sccm|mdt/release-notes")
inputs:
  docfx.yml: |
    documentId:
      sourceBasePath: sccm
    name: sccm
    product: Win
    files: sccm/**/*
    baseUrl: https://docs.com/sccm
    routes:
      sccm/: .
  sccm/mdt/release-notes.md:
outputs:
  sccm/mdt/release-notes.json: |
    { "document_id": "0b1c8a5d-b639-d555-0850-b98a9010023c", "document_version_independent_id": "b20fdb1c-8d40-c3b2-2265-779a3f2dfe98", "depot_name": "Win.sccm" }
---
# generate index document id and version id
# backward compatible to docs.com
# document id = md5("Win.sccm|index.md") || md5("Win.sccm|mdm/index.md")
# version independent id = md5("Win.sccm|index") || md5("Win.sccm|mdm/index")
inputs:
  docfx.yml: |
    documentId:
      sourceBasePath: sccm
    name: sccm
    product: Win
    files: "**/*"
    baseUrl: https://docs.com/sccm
    routes:
      sccm/: .
  sccm/mdm/index.md:
  sccm/index.md:
outputs:
  sccm/index.json: |
    { "document_id": "29602e3e-439e-865c-f1c9-2eb706f97b31", "document_version_independent_id": "34196fc5-28d6-b496-a21f-8661876802c7" }
  sccm/mdm/index.json: |
    { "document_id": "1c42a151-6248-df0c-15e6-3b1158d7bee3", "document_version_independent_id": "beb14a44-b076-14b8-b9c5-b42f9e36b973" }
---
# generate same document id and version id with 'redirection with document id'
# A => B, B's ids should be same with A's
inputs:
  docfx.yml: |
    documentId:
      sourceBasePath: docs/
    baseUrl: https://docs.com/docs
    routes:
      docs/: .
    redirections:
      docs/a.md: /docs/x
      docs/b.md: /docs/y?query=value#bookmark
      docs/c.md: /docs/folder1/index
      docs/d.md: /docs/folder2/
      docs/e.md: /docs/z
      docs/f.md: /docs/e
  docs/x.md:
  docs/y.md:
  docs/z.md:
  docs/folder1/index.md:
  docs/folder2/index.md:
outputs:
  docs/x.json: |
    { "document_id": "780484e9-a367-97ab-ba7d-a19f3b378a80", "document_version_independent_id": "e9b3f4e2-1a78-4b5d-fbb4-03e0a33e38f5" }
  docs/y.json: |
    { "document_id": "746406e9-2aac-1b22-259a-b6712b49c610", "document_version_independent_id": "d93f906b-e1e0-e950-45b4-ce1e777af3e6" }
  docs/z.json: |
    { "document_id": "3c1b64b6-2acf-2a8d-0b02-687e4c6751b6", "document_version_independent_id": "b7faa2da-5935-b5fb-4609-dd030b0e74ab" }
  docs/folder1/index.json: |
    { "document_id": "fdb5a0d7-b68e-c465-9c5e-54a5cda94902", "document_version_independent_id": "92a5a770-f05f-b8bb-81c9-a8d786a9e608" }
  docs/folder2/index.json: |
    { "document_id": "64dd67d2-325f-bc70-d1b3-0106d0cb71e3", "document_version_independent_id": "5f485788-9aee-232c-f1f0-66c205d6e9a9" }
---
# generate different document id and version id with 'redirection without document id'
inputs:
  docfx.yml: |
    documentId:
      sourceBasePath: sccm
    name: sccm
    product: Win
    files: "**/*"
    baseUrl: https://docs.com/sccm
    routes:
      sccm/: .
    redirectionsWithoutId:
      sccm/mdm/index.md: /sccm/mdm/understand/hybrid-mobile-device-management
  sccm/mdm/understand/hybrid-mobile-device-management.md:
outputs:
  sccm/mdm/understand/hybrid-mobile-device-management.json: |
    { "document_id": "7412621b-4920-dc7e-bed6-1f1ea774f7dd", "document_version_independent_id": "de5d1641-2c0e-1158-7611-e52a22d96a5e" }
---
# redirect with document id resolve relative redirect_url
# publish item's redirect_url keeps user's input
inputs:
  docfx.yml: |
    documentId:
      sourceBasePath: develop
    name: partner-center-sdk
    product: MSDN
    files: "develop/**/*"
    baseUrl: https://docs.com/partner-center-sdk
    routes:
      develop/: .
    redirections:
      develop/agreement-metadata.md: agreement-metadata-resources
  develop/agreement-metadata-resources.md:
outputs:
  partner-center-sdk/agreement-metadata-resources.json: |
    { "document_id": "ad740933-6e60-291e-14ba-8a4e81133047", "document_version_independent_id": "e8a46a09-153a-2eac-1bd0-0aad104a6616" }
  .publish.json: |
    {
      "files": [
          {
              "url": "/partner-center-sdk/agreement-metadata",
              "source_path": "develop/agreement-metadata.md",
              "locale": "en-us",
              "redirect_url": "/partner-center-sdk/agreement-metadata-resources"
          },
          {
              "url": "/partner-center-sdk/agreement-metadata-resources",
              "path": "partner-center-sdk/agreement-metadata-resources.json",
              "source_path": "develop/agreement-metadata-resources.md",
              "locale": "en-us"
          }
      ]
    }
---
# Show warning if two or more files redirect to the same file with document id
inputs:
  docfx.yml: |
    documentId:
      sourceBasePath: sccm
    name: sccm
    product: Win
    files: "**/*"
    baseUrl: https://docs.com/sccm
    routes:
      sccm/: .
    redirections:
      sccm/mdm/index.md: /sccm/mdm/understand/hybrid-mobile-device-management
      sccm/mdm/index2.md: /sccm/mdm/understand/hybrid-mobile-device-management
  sccm/mdm/understand/hybrid-mobile-device-management.md:
outputs:
  sccm/mdm/understand/hybrid-mobile-device-management.json: |
    { "document_id": "1c42a151-6248-df0c-15e6-3b1158d7bee3", "document_version_independent_id": "beb14a44-b076-14b8-b9c5-b42f9e36b973" }
  .errors.log: |
    ["warning","redirection-url-conflict","The '/sccm/mdm/understand/hybrid-mobile-device-management' appears twice or more in the redirection mappings","docfx.yml",11,23]
---
# redirect to empty URL
inputs:
  docfx.yml: |
    redirections:
      sccm/mdm/index.md: ""
      "": /docfx/test
      a.md:
outputs:
  .errors.log: |
    ["error","redirection-is-empty","The key or value of redirection 'sccm/mdm/index.md: ' is null or empty","docfx.yml",2,22]
    ["error","redirection-is-empty","The key or value of redirection ': /docfx/test' is null or empty","docfx.yml",3,7]
    ["error","redirection-is-empty","The key or value of redirection 'a.md: ' is null or empty","docfx.yml",4,8]
---
# The dest to redirection url does not match any files's publish URL, but the redirect_with_id flag has been set as true
inputs:
  docfx.yml: |
    redirections:
      docs/a.md: "/docs/x"
      docs/c.md: "/docs/x#bookmark"
      docs/b.md: "http://hostname/test"
      docs/d.md: "/docs/folder0"
      docs/f.md: "/docs/folder0/"
      docs/h.md: "/docs/folder0/index"
outputs:
  .errors.log: |
    ["suggestion","redirection-url-not-existed","The redirect url 'http://hostname/test' does not match any file's publish URL, but the redirect_with_id flag has been set as true, please use a valid redirection url or add this rule to `redirectionsWithoutId`","docfx.yml",4,14]
    ["suggestion","redirection-url-not-existed","The redirect url '/docs/x' does not match any file's publish URL, but the redirect_with_id flag has been set as true, please use a valid redirection url or add this rule to `redirectionsWithoutId`","docfx.yml",2,14]
    ["suggestion","redirection-url-not-existed","The redirect url '/docs/x#bookmark' does not match any file's publish URL, but the redirect_with_id flag has been set as true, please use a valid redirection url or add this rule to `redirectionsWithoutId`","docfx.yml",3,14]
    ["suggestion","redirection-url-not-existed","The redirect url '/docs/folder0' does not match any file's publish URL, but the redirect_with_id flag has been set as true, please use a valid redirection url or add this rule to `redirectionsWithoutId`","docfx.yml",5,14]
    ["suggestion","redirection-url-not-existed","The redirect url '/docs/folder0/' does not match any file's publish URL, but the redirect_with_id flag has been set as true, please use a valid redirection url or add this rule to `redirectionsWithoutId`","docfx.yml",6,14]
    ["suggestion","redirection-url-not-existed","The redirect url '/docs/folder0/index' does not match any file's publish URL, but the redirect_with_id flag has been set as true, please use a valid redirection url or add this rule to `redirectionsWithoutId`","docfx.yml",7,14]
---
# generate document id with depot mapping and directory mapping
# id = hash({mapped_depot_name}|{mapped_file_in_docset})
# version_independent_id = hash({mapped_depot_name}|{file_path})
inputs:
  docfx.yml: |
    documentId:
      depotMappings:
        articles/iot-central/: MSDN.microsoft-iot-central
      directoryMappings:
        articles\iot-central: articles
        articles\billing/billing-add-change-azure-subscription-administrator.md: articles
    name: azure-documents
    product: Azure
    files: "**/*"
    baseUrl: https://docs.com/Azure
    routes:
      articles/: .
  articles/iot-central/concepts-architecture.md:
  articles/billing/billing-add-change-azure-subscription-administrator.md:
outputs:
  azure/iot-central/concepts-architecture.json: |
    {"document_id":"7e13132e-7847-dc4f-90d5-32a233d1c81a","document_version_independent_id":"d9cc5ab8-926a-8a5a-312c-10ca36619bad"}
  azure/billing/billing-add-change-azure-subscription-administrator.json: |
    {"document_id":"f5624f3e-5fbf-6f0f-93cf-a4d5aa93ccf8","document_version_independent_id":"9ca6d22b-e684-4e65-cab3-c272189a3ddc"}
---
# yaml&json toc metadata
inputs:
  docfx.yml:
  docs/json/TOC.json: |
    {
      "metadata": {"a":"b"},
      "items": [{ "name": "title" }]
    }
  docs/yaml/TOC.yml: |
    metadata:
      a: b
    items:
      - name: title
outputs:
  docs/json/toc.json: |
    {  
      "metadata": {"a": "b"},
      "items":[{"name":"title"}]
    }
  docs/yaml/toc.json: |
    {  
      "metadata": {"a": "b"},
      "items":[{"name":"title"}]
    }
---
# yaml&json toc leaf metadata
inputs:
  docfx.yml:
  docs/json/TOC.json: |
    [{ "name": "title", "a": "b" }]
  docs/yaml/TOC.yml: |
    - name: title
      a: b
outputs:
  docs/json/toc.json: |
    {  
      "items":[{"name":"title", "a": "b"}]
    }
  docs/yaml/toc.json: |
    {  
      "items":[{"name":"title", "a": "b"}]
    }
---
# yaml&json toc metadata inclusion
# child's root metadata will be dropped
inputs:
  docfx.yml:
  docs/json/TOC.json: |
    {  
      "metadata": {"a": "b"},
      "items":[{"name":"title", "c": "d"}]
    }
  docs/yaml/TOC.yml: |
    - name: toc reference
      tocHref: ../json/TOC.json
outputs:
  docs/yaml/toc.json: |
    {  
      "items":[{"name":"toc reference", "items": [{"name":"title", "c": "d"}]}]
    }
---
# TOC does not respect global metadata and file metadata
inputs:
  docfx.yml: |
    globalMetadata:
      a: b
  docs/json/TOC.json: |
    [{"name":"title"}]
  docs/yaml/TOC.yml: |
    metadata:
      c: d
    items:
      - name: title
  docs/md/TOC.md: |
    # title
outputs:
  docs/yaml/toc.json: |
    {  
      "items": [{ "name": "title" }], "metadata": { "a": undefined, "c": "d"}
    }
  docs/json/toc.json: |
    {  
      "items": [{ "name": "title" }], "metadata": { "a": undefined }
    }
  docs/md/toc.json: |
    {  
      "items": [{ "name": "title" }], "metadata": { "a": undefined }
    }
---
# redirect to redirect
inputs:
  docfx.yml: |
    name: azure-documents
    product: Azure
    files: "**/*"
    baseUrl: https://docs.com/azure
    routes:
      articles/: .
    redirections:
      articles/active-directory/active-directory-saas-splunkenterpriseandsplunkcloud-tutorial.md: /azure/active-directory/saas-apps/splunkenterpriseandsplunkcloud-tutorial
      articles/active-directory/active-directory-saas-splunk-enterprise-and-splunk-cloud-tutorial.md: /azure/active-directory/active-directory-saas-splunkenterpriseandsplunkcloud-tutorial
  articles/active-directory/saas-apps/splunkenterpriseandsplunkcloud-tutorial.md:
outputs:
  azure/active-directory/saas-apps/splunkenterpriseandsplunkcloud-tutorial.json: |
    {"document_id":"b1cdf77e-673b-8b3a-3232-78f3d2b225dd","document_version_independent_id":"bde2976d-40d3-f729-128d-0caa664da662"}
---
# landing page is treated as *.md when calculating document id
# id: 
#   new Guid(md5.ComputeHash(new MemoryStream(Encoding.UTF8.GetBytes("Azure.azure-documents|articles/active-directory-b2c/*.md")))).ToString()
# document_version_independent_id : 
#   new Guid(md5.ComputeHash(new MemoryStream(Encoding.UTF8.GetBytes("Azure.azure-documents|active-directory-b2c/*")))).ToString()
inputs:
  docfx.yml: |
    product: Azure
    name: azure-documents
    files: "**/*"
    baseUrl: https://docs.com/articles
    routes:
      articles/: .
  articles/active-directory-b2c/index.yml : |
    ### YamlMime:YamlDocument
    documentType: LandingData
  articles/active-directory-b2c/test.yml : |
    ### YamlMime:YamlDocument
    documentType: LandingData
outputs:
  articles/active-directory-b2c/index.json: |
    {"metadata": { "document_id": "4b5e7225-dae6-053e-4657-c4731dbd7d64", "document_version_independent_id": "fdf17736-63c4-6c9f-825b-393312bbd63a"}}
  articles/active-directory-b2c/test.json: |
    {"metadata": { "document_id": "89987066-1e32-4f92-1957-329cfa9de0a0", "document_version_independent_id": "8f254336-d196-b36f-649e-dec30465941b"}}
---
# index.yml's document id also follows the redirection rules
# trailing 'index' redirect-to will be trimmed
inputs:
  docfx.yml: |
    product: Azure
    name: azure-documents
    files: "**/*"
    baseUrl: https://docs.com/azure
    routes:
      articles/: .
    redirections:
      articles/virtual-machines/windows/classic/web-app-visual-studio.md: /azure/app-service/index
  articles/app-service/index.yml : |
    ### YamlMime:YamlDocument
    documentType: LandingData
outputs:
  azure/app-service/index.json: |
    {"metadata":{ "document_id": "a0e220f7-d5b9-6cca-580c-3d49fe3b478f", "document_version_independent_id": "41d29d50-009e-41b4-ab51-371ed5bba821"}}
---
# Generate canonical URL
inputs:
  docfx.yml: |
    files: "**/*"
    baseUrl: "https://docs.microsoft.com"
    routes:
      articles/: azure/
  articles/app-service/index.md:
  articles/app-service/index.experimental.md:
outputs:
  azure/app-service/index.json: |
    { "canonical_url": "https://docs.microsoft.com/en-us/azure/app-service/" }
  azure/app-service/index.experimental.json: |
    { "canonical_url": "https://docs.microsoft.com/en-us/azure/app-service/" }
---
# redirection defined in markdown yaml metadata is not supported
inputs:
  docfx.yml: |
    redirectionsWithoutId:
      docs/a.md: /a
  docs/a.md: |
    ---
    redirect_url: https://docfx.com/b
    ---
outputs:
  .errors.log: |
    ["warning","attribute-reserved","Attribute redirect_url is reserved for use by Docs. Remove it from your file metadata.","docs/a.md",2,1]
    ["error","publish-url-conflict","Two or more files publish to the same url '/docs/a': 'docs/a.md', 'docs/a.md [redirection]'"]
---
# redirection defined in file metadata is not supported
inputs:
  docfx.yml: |
    fileMetadata:
      redirect_url:
        docs/a.md: https://docfx.com
  docs/a.md:
outputs:
  docs/a.json:
  .errors.log: |
    ["warning","attribute-reserved","Attribute redirect_url is reserved for use by Docs. Remove it from your file metadata.","docfx.yml",3,16]
---
# document_id defined in YAML file metadata is not supported
inputs:
  docfx.yml:
  docs/index.yml: |
    ### YamlMime:YamlDocument
    documentType: LandingData
    title: some title
    metadata:
      document_id: some id
  docs/a.md:
outputs:
  docs/a.json:
  docs/index.json:
  .errors.log: |
    ["warning","attribute-reserved","Attribute document_id is reserved for use by Docs. Remove it from your file metadata.","docs/index.yml",5,3]
---
# redirection defined in global metadata is not supported
inputs:
  docfx.yml: |
    globalMetadata:
      redirect_url: https://docfx.com
  docs/a.md:
outputs:
  docs/a.json:
  .errors.log: |
    ["warning","attribute-reserved","Attribute redirect_url is reserved for use by Docs. Remove it from your file metadata.","docfx.yml",2,3]
---
# resolve breadcrumb_path
inputs:
  docfx.yml: |
    globalMetadata:
      breadcrumb_path: ~/breadcrumbs/TOC.json
  a.md:
  breadcrumbs/TOC.json: '{}'
outputs:
  a.json: |
    { "breadcrumb_path": "breadcrumbs/toc.json" }
  breadcrumbs/toc.json:
---
# Metadata should work for fields marked with SourceInfo<T>
inputs:
  docfx.yml: |
    fileMetadata:
      author:
        '**/*': name
  a.md:
outputs:
  a.json:
---
# Duplicated metadata
inputs:
  docfx.yml:
  docs/a.md: |
    ---
    a: a
    a: b
    ---
outputs:
  docs/a.json: |
    {"a": "b"}
  .errors.log: |
    ["warning","yaml-duplicate-key","Key 'a' is already defined, remove the duplicate key.","docs/a.md",3,1]
---
# Invalid yaml syntax in yaml header
inputs:
  docfx.yml:
  docs/a.md: |
    ---
    a: a: b
    title: A
    ---
    # B
outputs:
  docs/a.json: |
    {"a": undefined, "title": "B"}
  .errors.log: |
    ["warning","yaml-header-syntax-error","Mapping values are not allowed in this context.","docs/a.md",2,5]
---
# Input metadata doesn't overwrite system generated metadata
inputs:
  docfx.yml:
  docs/a.md: |
    ---
    wordCount: 15
    document_id: 123
    ---
outputs:
  docs/a.json: |
    { "wordCount": 0, "document_id": "fa697b4e-3e52-77f6-2219-39040f6070da" }
  .errors.log: |
    ["warning","attribute-reserved","Attribute wordCount is reserved for use by Docs. Remove it from your file metadata.","docs/a.md",2,1]
    ["warning","attribute-reserved","Attribute document_id is reserved for use by Docs. Remove it from your file metadata.","docs/a.md",3,1]
---
# Title in file metadata should overwrite H1
inputs:
  docfx.yml: |
    fileMetadata:
      title:
        docs/a.md: Title to overwrite
  docs/a.md: |
    # Title for a
outputs:
  docs/a.json: |
    {"title": "Title to overwrite"}
