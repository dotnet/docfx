# Metadata keys are case sensitive
inputs:
  docfx.yml: |
    globalMetadata:
      key: global
      KEY: GLOBAL
  docs/a.md: |
    ---
    key: header
    KEY: HEADER
    ---
outputs:
  docs/a.json: |
    { "key": "header", "KEY": "HEADER" }
---
# Preserve null custom metadata
inputs:
  docfx.yml:
  docs/a.md: |
    ---
    ms.custom-metadata:
    ---
outputs:
  docs/a.json: |
    { "ms.custom-metadata": null }
  build.log: |
    ["info","null-value","'ms.custom-metadata' contains null value","docs/a.md",2,1]
---
# Overwrite global metadata with null in yaml header
inputs:
  docfx.yml: |
    globalMetadata:
      ms.custom-metadata: not-null
  a.md: |
    ---
    ms.custom-metadata:
    ---
outputs:
  a.json: |
    { "ms.custom-metadata": null }
  build.log: |
    ["info","null-value","'ms.custom-metadata' contains null value","a.md",2,1]
---
# Report error for invalid yaml header value type
inputs:
  docfx.yml:
  docs/a.md: |
    ---
    locale: {}
    ---
outputs:
  build.log: |
    ["error","violate-schema","Expected type String, please input String or type compatible with String.","docs/a.md",2,9]
    ["info","invalid-metadata-type","Metadata 'locale' can only be a scalar value or string array","docs/a.md",2,9]
---
# Report error for invalid yaml header value type as array
inputs:
  docfx.yml:
  docs/a.md: |
    ---
    author:
      - a
      - b
    ---
outputs:
  build.log: |
    ["error","violate-schema","Cannot deserialize the current JSON array *","docs/a.md",3,3]
---
# generate normal document id and version id
# backward compatible to docs.com
# document id = md5("Win.sccm|mdt/release-notes.md")
# version independent id = md5("Win.sccm|mdt/release-notes")
inputs:
  docfx.yml: |
    documentId:
      sourceBasePath: sccm
      siteBasePath: sccm
    name: sccm
    product: Win
    files: sccm/**/*
  sccm/mdt/release-notes.md:
outputs:
  sccm/mdt/release-notes.json: |
    { "content": "<div></div>", "document_id": "0b1c8a5d-b639-d555-0850-b98a9010023c", "document_version_independent_id": "b20fdb1c-8d40-c3b2-2265-779a3f2dfe98" }
---
# generate index document id and version id
# backward compatible to docs.com
# document id = md5("Win.sccm|index.md") || md5("Win.sccm|mdm/index.md")
# version independent id = md5("Win.sccm|index") || md5("Win.sccm|mdm/index")
inputs:
  docfx.yml: |
    documentId:
      sourceBasePath: sccm
      siteBasePath: sccm
    name: sccm
    product: Win
    files: "**/*"
  sccm/mdm/index.md:
  sccm/index.md:
outputs:
  sccm/index.json: |
    { "content": "<div></div>", "document_id": "29602e3e-439e-865c-f1c9-2eb706f97b31", "document_version_independent_id": "34196fc5-28d6-b496-a21f-8661876802c7" }
  sccm/mdm/index.json: |
    { "content": "<div></div>", "document_id": "1c42a151-6248-df0c-15e6-3b1158d7bee3", "document_version_independent_id": "beb14a44-b076-14b8-b9c5-b42f9e36b973" }
---
# generate same document id and version id with 'redirection with document id'
# A => B, B's ids should be same with A's
inputs:
  docfx.yml: |
    documentId:
      sourceBasePath: sccm
      siteBasePath: sccm
    name: sccm
    product: Win
    files: "**/*"
    redirections:
      sccm/mdm/index.md: /sccm/mdm/understand/hybrid-mobile-device-management
  sccm/mdm/understand/hybrid-mobile-device-management.md:
outputs:
  sccm/mdm/understand/hybrid-mobile-device-management.json: |
    { "document_id": "1c42a151-6248-df0c-15e6-3b1158d7bee3", "document_version_independent_id": "beb14a44-b076-14b8-b9c5-b42f9e36b973" }
---
# generate different document id and version id with 'redirection with document id' when it's out of build scope
# A => B, A is out of build scope, B's ids should be different with A's
inputs:
  docfx.yml: |
    documentId:
      sourceBasePath: sccm
      siteBasePath: sccm
    name: sccm
    product: Win
    files: "sccm/mdm/understand/hybrid-mobile-device-management.md"
    redirections:
      sccm/mdm/index.md: /sccm/mdm/understand/hybrid-mobile-device-management
  sccm/mdm/understand/hybrid-mobile-device-management.md:
outputs:
  sccm/mdm/understand/hybrid-mobile-device-management.json: |
    { "document_id": "7412621b-4920-dc7e-bed6-1f1ea774f7dd", "document_version_independent_id": "de5d1641-2c0e-1158-7611-e52a22d96a5e" }
  build.log: |
    ["info","redirection-out-of-scope","Redirection file 'sccm/mdm/index.md' will not be built because it is not included in build scope","docfx.yml",8,22]
---
# generate different document id and version id with 'redirection without document id'
inputs:
  docfx.yml: |
    documentId:
      sourceBasePath: sccm
      siteBasePath: sccm
    name: sccm
    product: Win
    files: "**/*"
    redirectionsWithoutId:
      sccm/mdm/index.md: /sccm/mdm/understand/hybrid-mobile-device-management
  sccm/mdm/understand/hybrid-mobile-device-management.md:
outputs:
  sccm/mdm/understand/hybrid-mobile-device-management.json: |
    { "document_id": "7412621b-4920-dc7e-bed6-1f1ea774f7dd", "document_version_independent_id": "de5d1641-2c0e-1158-7611-e52a22d96a5e" }
---
# get conflicted redirection document id warning if two or more files redirect to the same file with document id
inputs:
  docfx.yml: |
    documentId:
      sourceBasePath: sccm
      siteBasePath: sccm
    name: sccm
    product: Win
    files: "**/*"
    redirections:
      sccm/mdm/index.md: /sccm/mdm/understand/hybrid-mobile-device-management
      sccm/mdm/index2.md: /sccm/mdm/understand/hybrid-mobile-device-management
  sccm/mdm/understand/hybrid-mobile-device-management.md:
outputs:
  sccm/mdm/understand/hybrid-mobile-device-management.json: |
    { "document_id": "1c42a151-6248-df0c-15e6-3b1158d7bee3", "document_version_independent_id": "beb14a44-b076-14b8-b9c5-b42f9e36b973" }
  build.log: |
    ["warning","redirected-id-conflict","Multiple documents redirected to '/sccm/mdm/understand/hybrid-mobile-device-management' with document id: 'sccm/mdm/index.md', 'sccm/mdm/index2.md'","docfx.yml"]
---
# redirect to empty URL
inputs:
  docfx.yml: |
    redirections:
      sccm/mdm/index.md: ""
      "": /docfx/test
outputs:
  build.log: |
    ["error","redirection-is-empty","The key or value of redirection 'sccm/mdm/index.md: ' is null or empty","docfx.yml",2,22]
    ["error","redirection-is-empty","The key or value of redirection ': /docfx/test' is null or empty","docfx.yml",3,7]
---
# generate document id with depot mapping and directory mapping
# id = hash({mapped_depot_name}|{mapped_file_in_docset})
# version_independent_id = hash({mapped_depot_name}|{file_path})
inputs:
  docfx.yml: |
    documentId:
      siteBasePath: azure
      depotMappings:
        articles/iot-central/: MSDN.microsoft-iot-central
      directoryMappings:
        articles\iot-central: articles
        articles\billing/billing-add-change-azure-subscription-administrator.md: articles
    name: azure-documents
    product: Azure
    files: "**/*"
    routes:
      articles/: "azure/"
  articles/iot-central/concepts-architecture.md:
  articles/billing/billing-add-change-azure-subscription-administrator.md:
outputs:
  azure/iot-central/concepts-architecture.json: |
    {"document_id":"7e13132e-7847-dc4f-90d5-32a233d1c81a","document_version_independent_id":"d9cc5ab8-926a-8a5a-312c-10ca36619bad"}
  azure/billing/billing-add-change-azure-subscription-administrator.json: |
    {"document_id":"f5624f3e-5fbf-6f0f-93cf-a4d5aa93ccf8","document_version_independent_id":"9ca6d22b-e684-4e65-cab3-c272189a3ddc"}
---
# yaml&json toc metadata
inputs:
  docfx.yml:
  docs/json/TOC.json: |
    {
      "metadata": {"a":"b"},
      "items": [{ "name": "title" }]
    }
  docs/yaml/TOC.yml: |
    metadata:
      a: b
    items:
      - name: title
outputs:
  docs/json/toc.json: |
    {  
      "metadata": {"a": "b"},
      "items":[{"name":"title"}]
    }
  docs/yaml/toc.json: |
    {  
      "metadata": {"a": "b"},
      "items":[{"name":"title"}]
    }
---
# yaml&json toc leaf metadata
inputs:
  docfx.yml:
  docs/json/TOC.json: |
    [{ "name": "title", "a": "b" }]
  docs/yaml/TOC.yml: |
    - name: title
      a: b
outputs:
  docs/json/toc.json: |
    {  
      "items":[{"name":"title", "a": "b"}]
    }
  docs/yaml/toc.json: |
    {  
      "items":[{"name":"title", "a": "b"}]
    }
---
# yaml&json toc metadata inclusion
# child's root metadata will be dropped
inputs:
  docfx.yml:
  docs/json/TOC.json: |
    {  
      "metadata": {"a": "b"},
      "items":[{"name":"title", "c": "d"}]
    }
  docs/yaml/TOC.yml: |
    - name: toc reference
      tocHref: ../json/TOC.json
outputs:
  docs/yaml/toc.json: |
    {  
      "items":[{"name":"toc reference", "items": [{"name":"title", "c": "d"}]}]
    }
---
# TOC does not respect global metadata and file metadata
inputs:
  docfx.yml: |
    globalMetadata:
      a: b
  docs/json/TOC.json: |
    [{"name":"title"}]
  docs/yaml/TOC.yml: |
    metadata:
      c: d
    items:
      - name: title
  docs/md/TOC.md: |
    # title
outputs:
  docs/yaml/toc.json: |
    {  
      "items": [{ "name": "title" }], "metadata": { "!a": null, "c": "d"}
    }
  docs/json/toc.json: |
    {  
      "items": [{ "name": "title" }], "metadata": { "!a": null }
    }
  docs/md/toc.json: |
    {  
      "items": [{ "name": "title" }], "metadata": { "!a": null }
    }
---
# redirect to redirect
inputs:
  docfx.yml: |
    documentId:
      siteBasePath: azure
    name: azure-documents
    product: Azure
    files: "**/*"
    routes:
      articles/: "azure/"
    redirections:
      articles/active-directory/active-directory-saas-splunkenterpriseandsplunkcloud-tutorial.md: /azure/active-directory/saas-apps/splunkenterpriseandsplunkcloud-tutorial
      articles/active-directory/active-directory-saas-splunk-enterprise-and-splunk-cloud-tutorial.md: /azure/active-directory/active-directory-saas-splunkenterpriseandsplunkcloud-tutorial
  articles/active-directory/saas-apps/splunkenterpriseandsplunkcloud-tutorial.md:
outputs:
  azure/active-directory/saas-apps/splunkenterpriseandsplunkcloud-tutorial.json: |
    {"document_id":"b1cdf77e-673b-8b3a-3232-78f3d2b225dd","document_version_independent_id":"bde2976d-40d3-f729-128d-0caa664da662"}
---
# index.yml is treated as index.md when calculating document id
# id: 
#   new Guid(md5.ComputeHash(new MemoryStream(Encoding.UTF8.GetBytes("Azure.azure-documents|articles/active-directory-b2c/index.md")))).ToString()
# document_version_independent_id : 
#   new Guid(md5.ComputeHash(new MemoryStream(Encoding.UTF8.GetBytes("Azure.azure-documents|active-directory-b2c/index")))).ToString()
inputs:
  docfx.yml: |
    product: Azure
    name: azure-documents
    documentId:
      siteBasePath: articles
    files: "**/*"
  articles/active-directory-b2c/index.yml : |
    ### YamlMime:YamlDocument
    documentType: LandingData
outputs:
  articles/active-directory-b2c/index.json: |
    { "document_id": "4b5e7225-dae6-053e-4657-c4731dbd7d64", "document_version_independent_id": "fdf17736-63c4-6c9f-825b-393312bbd63a"}
---
# index.yml's document id also follows the redirection rules
inputs:
  docfx.yml: |
    product: Azure
    name: azure-documents
    documentId:
      siteBasePath: azure
    files: "**/*"
    routes:
      articles/: "azure/"
    redirections:
      articles/virtual-machines/windows/classic/web-app-visual-studio.md: /azure/app-service/
  articles/app-service/index.yml : |
    ### YamlMime:YamlDocument
    documentType: LandingData
outputs:
  azure/app-service/index.json: |
    { "document_id": "a0e220f7-d5b9-6cca-580c-3d49fe3b478f", "document_version_independent_id": "41d29d50-009e-41b4-ab51-371ed5bba821"}
---
# Generate canonical URL
inputs:
  docfx.yml: |
    files: "**/*"
    baseUrl: "https://docs.microsoft.com"
    routes:
      articles/: "azure/"
  articles/app-service/index.md:
  articles/app-service/index.experimental.md:
outputs:
  azure/app-service/index.json: |
    { "canonical_url": "https://docs.microsoft.com/en-us/azure/app-service/" }
  azure/app-service/index.experimental.json: |
    { "canonical_url": "https://docs.microsoft.com/en-us/azure/app-service/" }
---
# redirection defined in markdown yaml metadata is not supported
inputs:
  docfx.yml: |
    redirections:
      docs/a.md: /a
  docs/a.md: |
    ---
    redirect_url: https://docfx.com/b
    ---
outputs:
  build.log: |
    ["warning","reserved-metadata","Metadata 'redirect_url' is reserved by docfx, remove this metadata","docs/a.md",2,1]
    ["error","publish-url-conflict","Two or more files publish to the same url '/docs/a': 'docs/a.md', 'docs/a.md <redirection>'"]
---
# redirection defined in file metadata is not supported
inputs:
  docfx.yml: |
    fileMetadata:
      redirect_url:
        docs/a.md: https://docfx.com
  docs/a.md:
outputs:
  docs/a.json:
  build.log: |
    ["warning","reserved-metadata","Metadata 'redirect_url' is reserved by docfx, remove this metadata","docfx.yml",3,16]
---
# document_id defined in YAML file metadata is not supported
inputs:
  docfx.yml:
  docs/index.yml: |
    ### YamlMime:YamlDocument
    documentType: LandingData
    title: some title
    metadata:
      document_id: some id
  docs/a.md:
outputs:
  docs/a.json:
  docs/index.json:
  build.log: |
    ["warning","reserved-metadata","Metadata 'document_id' is reserved by docfx, remove this metadata","docs/index.yml",5,3]
---
# redirection defined in global metadata is not supported
inputs:
  docfx.yml: |
    globalMetadata:
      redirect_url: https://docfx.com
  docs/a.md:
outputs:
  docs/a.json:
  build.log: |
    ["warning","reserved-metadata","Metadata 'redirect_url' is reserved by docfx, remove this metadata","docfx.yml",2,3]
---
# resolve breadcrumb_path
inputs:
  docfx.yml: |
    globalMetadata:
      breadcrumb_path: ~/breadcrumbs/TOC.json
  a.md:
  breadcrumbs/TOC.json: '{}'
outputs:
  a.json: |
    breadcrumb_path: breadcrumbs/toc.json
  breadcrumbs/toc.json:
---
# Metadata value must be scalar or scalar array
inputs:
  docfx.yml: |
    globalMetadata:
      key1: {}
    fileMetadata:
      key2:
        '**/*':
          - a: 1
  a.md:
outputs:
  a.json:
  build.log: |
    ["info","invalid-metadata-type","Metadata 'key1' can only be a scalar value or string array","docfx.yml",2,9]
    ["info","invalid-metadata-type","Metadata 'key2' can only be a scalar value or string array","docfx.yml",6,7]
---
# Additional metadata validation from external JSON schema
inputs:
  docfx.yml: |
    metadataSchema: schema.json
    globalMetadata:
      key1: []
    fileMetadata:
      key2:
        '**/*': XNAGameStudio
  schema.json: |
    {
      "properties":{
        "key1": { "type": "string" },
        "key2": { "type": "string", "enum": ["VS", "MSDN"] },
        "key3": { "type": "integer" }
      }
    }
  a.md: |
    ---
    key3: net462
    ---
outputs:
  build.log: |
    ["error","violate-schema","Expected type String, please input String or type compatible with String.","docfx.yml",3,9]
    ["error","undefined-value","Value 'XNAGameStudio' is not accepted. Valid values: 'MSDN', 'VS'","docfx.yml",6,13]
    ["error","violate-schema","Expected type Integer, please input Integer or type compatible with Integer.","a.md",2,7]
---
# Metadata should work for fields marked with SourceInfo<T>
inputs:
  docfx.yml: |
    fileMetadata:
      author:
        '**/*': name
  a.md:
outputs:
  a.json:
