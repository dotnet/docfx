# Build with --legacy
commands:
  - build --legacy
repos:
  https://docs.com/legacy:
  - files:
      docfx.yml: |
        theme: https://docs.com/template
        redirections:
          a.md: /b
      c.md: |
        ---
        api_name:
          - "API Name"
        ms.author: yufeih
        ---
        [d](d.png)
      d.png:
      TOC.md: |
        # [c](c.md)
  https://docs.com/template:
  - files:
      ContentTemplate/Conceptual.mta.json.js: |
        exports.transform = function (model) {
          return {
            content: JSON.stringify(model)
          }
        }
      ContentTemplate/toc.json.js: |
        exports.transform = function (model) {
          return {
            content: JSON.stringify(model)
          }
        }
outputs:
  a.raw.page.json:
  a.mta.json: |
    { "locale": "en-us", "redirect_url": "/b" }
  c.raw.page.json: |
    {
      "content": "<p><a href=\"d.png\" data-linktype=\"relative-path\">d</a></p>\n",
      "rawMetadata": { "ms.author": "yufeih", "!robots": null, "api_name": ["API Name"] },
      "themesRelativePathToOutputRoot": "_themes/",
      "pageMetadata": "
        <meta name=\"_path\" content=\"c.json\" />
        <meta name=\"APIName\" content=\"API Name\" />
        <meta name=\"conceptual\" content=\"&lt;p&gt;&lt;a href=&quot;d.png&quot; data-linktype=&quot;relative-path&quot;&gt;d&lt;/a&gt;&lt;/p&gt;\n\" />
        <meta name=\"depot_name\" content=\".\" />
        <meta name=\"document_id\" content=\"fdb5a0d7-b68e-c465-9c5e-54a5cda94902\" />
        <meta name=\"document_version_independent_id\" content=\"92a5a770-f05f-b8bb-81c9-a8d786a9e608\" />
        <meta name=\"locale\" content=\"en-us\" />
        <meta name=\"ms.author\" content=\"yufeih\" />
        <meta name=\"rawTitle\" content=\"\" />
        <meta name=\"search.ms_docsetname\" content=\"\" />
        <meta name=\"search.ms_product\" content=\"\" />
        <meta name=\"search.ms_sitename\" content=\"Docs\" />
        <meta name=\"site_name\" content=\"Docs\" />
        <meta name=\"toc_rel\" content=\"toc.json\" />
        <meta name=\"updated_at\" content=\"2018-10-30 12:00 AM\" />
        <meta name=\"word_count\" content=\"1\" />
        <meta name=\"wordCount\" content=\"1\" />"
    }
  c.mta.json: |
    { "locale": "en-us", "ms.author": "yufeih", "is_dynamic_rendering": true }
  toc.json:
  toc.mta.json:
  .manifest.json:
  .dependency-map.json:
  filemap.json:
  op_aggregated_file_map_info.json:
  .publish.json:
  xrefmap.json:
---
# Raw metadata generated for template
# todo: remove this test and make raw model as our page model
repos:
  https://github.com/a/rawmetadata:
  - files:
      docfx.yml: |
        theme: https://docs.com/template1
        redirections:
          a.md: /b
        documentId:
          siteBasePath: rawmetadata
        routes:
          /: rawmetadata
      c.md: |
        ---
        api_name:
          - "API Name"
        ms.author: yufeih
        ---
        # Title
        [d](d.png)
      d.png:
      TOC.md: |
        # [c](c.md)
      index.yml: |
        ### YamlMime:YamlDocument
        documentType: LandingData
        metadata:
          document_id: abc
  https://docs.com/template1:
  - files:
      readme.md:
outputs:
  rawmetadata/c.json:
  rawmetadata/d.png:
  rawmetadata/toc.json:
  rawmetadata/index.json:
  .publish.json: |
    {"files": [
      {
        "url": "/rawmetadata/a",
        "redirect_url": "/b"
      }, 
      {
        "url": "/rawmetadata/c",
        "api_name": ["API Name"],
        "ms.author": "yufeih",
        "depot_name": ".",
        "search.ms_docsetname": "",
        "search.ms_product": "",
        "search.ms_sitename": "Docs",
        "locale": "en-us",
        "site_name": "Docs",
        "__global": {
        },
        "conceptual": "\n<p><a href=\"d.png\">d</a></p>\n",
        "_path": "c.json",
        "toc_rel": "toc.json",
        "word_count": 2,
        "wordCount": 2,
        "title": "Title",
        "rawTitle": "<h1 id=\"title\">Title</h1>",
        "_op_canonicalUrlPrefix": "https://docs.com/en-us/rawmetadata/",
        "layout": "Conceptual",
        "document_id": "fdb5a0d7-b68e-c465-9c5e-54a5cda94902",
        "document_version_independent_id": "92a5a770-f05f-b8bb-81c9-a8d786a9e608",
        "_op_gitContributorInformation": {
          "contributors": [],
          "author": {
            "display_name": "docfx",
            "id": "docfx@microsoft.com",
            "profile_url": null
          }
        },
        "content_git_url": "https://github.com/a/rawmetadata/blob/master/c.md",
        "gitcommit": "https://github.com/a/rawmetadata/blob/ff3949c8ae50dd622cd7c67952c8b020c93636a6/c.md",
        "original_content_git_url": "https://github.com/a/rawmetadata/blob/master/c.md",
        "original_content_git_url_template": "{repo}/blob/{branch}/c.md",
        "!metadata": null,
        "!contributors": null,
        "!bilingual": null,
        "!content": null,
        "!schema_type": null,
        "!author_info": null
      },
      {
        "url": "/rawmetadata/d.png"
      },
      {
        "url": "/rawmetadata/",
        "document_id": "b3c1f04b-5bdb-1c10-5237-024cf382b4cc",
        "_path": "index.json"
      },
      {
        "url": "/rawmetadata/toc.json"
      }]
    }
  build.log:
---
# Resolve link for landing page
inputs:
  docfx.yml:
  docs/index.yml: |
    ### YamlMime:YamlDocument
    documentType: LandingData
    title: REST API Documentation
    abstract:
      description: <a href="~/b">"b"</a>
      menu:
        items:
        - href: ~/b
  b.md: b
outputs:
  docs/index.json: |
    { "content": {"title":"REST API Documentation","abstract":{"menu":{"items":[{"href":"../b"}]},"description": "<p><a href=\"../b\">&quot;b&quot;</a></p>\n",},"documentType":"LandingData"} }
  b.json:
---
# Produce deterministic result when redirection and file share the same publish url
commands:
  - build --legacy
inputs:
  docfx.yml: |
    redirections:
      docs/a.md: /asdf
  docs/a.md:
outputs:
  build.log:
---
# Redirection file href shouldn't have extension
commands:
  - build --legacy
inputs:
  docfx.yml: |
    redirections:
      redirect.md: /redirect/to
  a.md: |
    [link](redirect.md)
outputs:
  a.raw.page.json: |
    { "content": "<p>\n<a data-linktype=\"relative-path\" href=\"redirect\">link</a></p>" }
  redirect.mta.json:
  redirect.raw.page.json:
---
# Legacy metadata black list
inputs:
  docfx.yml: |
    fileMetadata:
      content_type:
        docs/a.md: json
  docs/a.md: |
    ---
    ms.contentlang: 'C#'
    ---
outputs:
  docs/a.json:
  build.log: |
    ["warning","reserved-metadata","Metadata 'content_type' is reserved by docfx, remove this metadata: 'fileMetadata.content_type'","docfx.yml",3,5]
    ["warning","reserved-metadata","Metadata 'ms.contentlang' is reserved by docfx, remove this metadata: '['ms.contentlang']'","docs/a.md",2,17]
---
# Support metadata at root level for landing data
commands:
  - build --legacy
inputs:
  docfx.yml:
  docs/a.yml: |
    #YamlMime:LandingData
    title: my title
    key1: value1
    metadata:
      key2: value2
outputs:
  docs/a.raw.page.json: |
    {"key1":"value1","key2":"value2"}
---
# Context object type is TOC
commands:
  - build --legacy
inputs:
  docfx.yml:
  docs/a.yml: |
    #YamlMime: ContextObject
outputs:
  docs/a.json:
  .manifest.json: |
    {"files":[{"asset_id":"/docs/a.json","original":"docs/a.yml","source_relative_path":"docs/a.yml","original_type":"Conceptual","type":"Toc"}]}
