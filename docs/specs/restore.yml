---
# Restore dependencies with their children
repos:
  https://docs.com/restore/a:
    - files:
        docs/a.md: a2
    - files:
        docs/a.md: a1
inputs:
  docfx.yml: |
    dependencies:
      docfx-test-dependencies1: https://docs.com/restore/a
      docfx-test-dependencies2: https://docs.com/restore/a#b6720c99618c1d080f48da04922fc9756e93818c
  docs/a.md: |
    [link to 1](~/docfx-test-dependencies1/docs/a.md)
    [!include[include to 2](~/docfx-test-dependencies2/docs/a.md)
outputs:
  build.log: |
    ["warning","link-is-dependency","File 'docs/a.md' referenced by link '~/docfx-test-dependencies1/docs/a.md' will not be built because it is from a dependency docset","docs/a.md","",1,1]
  docs/a.json: |
    {"content":"<p><a href=\"%7E/docfx-test-dependencies1/docs/a.md\">link to 1</a></p>\n<p>a1</p>\n"}
---
# Restore dependencies azure repos with their children
repos:
  https://docascode.visualstudio.com/project/_git/a:
    - files:
        docs/a.md: a2
    - files:
        docs/a.md: a1
inputs:
  docfx.yml: |
    dependencies:
      docfx-test-dependencies1: https://docascode.visualstudio.com/project/_git/a
      docfx-test-dependencies2: https://docascode.visualstudio.com/project/_git/a#b6720c99618c1d080f48da04922fc9756e93818c
  docs/a.md: |
    [link to 1](~/docfx-test-dependencies1/docs/a.md)
    [!include[include to 2](~/docfx-test-dependencies2/docs/a.md)
outputs:
  build.log: |
    ["warning","link-is-dependency","File 'docs/a.md' referenced by link '~/docfx-test-dependencies1/docs/a.md' will not be built because it is from a dependency docset","docs/a.md","",1,1]
  docs/a.json: |
    {"content":"<p><a href=\"%7E/docfx-test-dependencies1/docs/a.md\">link to 1</a></p>\n<p>a1</p>\n"}
---
# Restore urls
repos:
  https://github.com/restore/b:
    - files:
        docs/a.md:
        docfx.yml: |
          gitHub:
            userCache: https://raw.githubusercontent.com/docascode/docfx-test-dependencies/github-user-cache-file/user_profile.json
            resolveUsers: true
      author: OsmondJiang
      email: xinjiang@microsoft.com
outputs:
  docs/a.json: |
    {"author":{"name":"OsmondJiang","profile_url":"https://github.com/OsmondJiang","display_name":"Osmond Jiang","id":"19990166"}}
---
# Restore urls with extends
repos:
  https://github.com/restore/c:
    - files:
        docs/a.md:
        docfx.yml: |
          extend: https://raw.githubusercontent.com/docascode/docfx-test-dependencies/extend-test-2/extend2.yml
      author: OsmondJiang
      email: xinjiang@microsoft.com
outputs:
  docs/a.json: |
    {"author":{"name":"OsmondJiang","profile_url":"https://github.com/OsmondJiang","display_name":"Osmond Jiang","id":"19990166"}}
---
# Restore dependencies with extends
repos:
  https://github.com/restore/d:
    - files:
        docs/a.md: d
inputs:
  docfx.yml: |
    extend: https://raw.githubusercontent.com/docascode/docfx-test-dependencies/extend-test-2/extend3.yml
  docs/a.md: |
    [link to 1](~/docfx-test-dependencies1/docs/a.md)
    [!include[include to 2](~/docfx-test-dependencies2/docs/a.md)
outputs:
  build.log: |
    ["warning","link-is-dependency","File 'docs/a.md' referenced by link '~/docfx-test-dependencies1/docs/a.md' will not be built because it is from a dependency docset","docs/a.md","",1,1]
  docs/a.json: |
    {"content":"<p><a href=\"%7E/docfx-test-dependencies1/docs/a.md\">link to 1</a></p>\n<p>d</p>\n"}
---
# Show error when download failed
inputs:
  docfx.yml: |
    extend: https://this-url-does-not-exit.com/this-is-a-bad-url
outputs:
  build.log: |
    ["error","download-failed","Download 'https://this-url-does-not-exit.com/this-is-a-bad-url' failed: *"]
---
# Show error when git clone failed
inputs:
  docfx.yml: |
    dependencies:
      error: https://github.com/docascode/docfx-test-dependencies#bad-branch
outputs:
  build.log: |
    ["error","committish-not-found","Cannot find branch, tag or commit 'bad-branch' for repo 'https://github.com/docascode/docfx-test-dependencies'."]
---
# Show error when dependent repo can't be found
commands:
  - build --no-restore
inputs:
  docfx.yml: |
    dependencies:
      dep: https://github.com/docascode/docfx-test-dependencies#bad-branch
  docs/a.md: |
    [test](dep/abc)
outputs:
  build.log: |
    ["error","need-restore","Cannot find dependency 'https://github.com/docascode/docfx-test-dependencies#bad-branch', did you forget to run `docfx restore`?","docs/a.md"]
---
# Show error when dependent URL can't be found
commands:
  - build --no-restore
inputs:
  docfx.yml: |
    contribution:
      gitCommitsTime: https://docs.microsoft.com/bad-url
outputs:
  build.log: |
    ["error","need-restore","Cannot find dependency 'https://docs.microsoft.com/bad-url', did you forget to run `docfx restore`?"]
---
# Show error when dependent file can't be found
inputs:
  docfx.yml: |
    contribution:
      gitCommitsTime: a.json
outputs:
  build.log: |
    ["error","file-not-found","*"]
---
# Restore longpath repo
inputs:
  docfx.yml: |
    dependencies:
      dep: https://github.com/docascode/docfx-test-dependencies#restore/long-path
  docs/test.md: 
    "[!INCLUDE[](~/dep/for-long-path-file-test-for-long-path-file-test-for-long-path-file-test-for-long-path-\
    file-test-for-long-path-file-test-for-long-path-file-test-for-long-path-file-test-for-long-path-file-tes\
    t-for-l/for-long-path-file-test-for-long-path-file-test-for-long-path-file-test-for-long-path-file-test-\
    for-long-path-file-test-for-long-path-file-test-for-long-path-file-test-for-long-path-file-test-for-long\
    -path-file-test-for-long-path-file-test-fo/for-long-path-test.md)]"
outputs:
  docs/test.json: |
    {
      "content": "<p>for long file path test.</p>"
    }
---
# Restore private azure repos with dependencies
inputs:
  docfx.yml: |
    dependencies:
      dep: https://ceapex.visualstudio.com/Engineering/_git/docs-host-vnext#c9c018c
    http:
      https://ceapex.visualstudio.com:
        headers:
          Authorization: Bearer {SYSTEM_ACCESS_TOKEN}
  docs/a.md: |
    [link to readmd](~/dep/README.md)
environments:
  - SYSTEM_ACCESS_TOKEN
outputs:
  docs/a.json:
  build.log: |
    ["warning","link-is-dependency","File 'README.md' referenced by link '~/dep/README.md' will not be built because it is from a dependency docset","docs/a.md","",1,1]
---
# Restored repo should be always retrieved
repos:
  https://docs.com/restore/x#master1:
    - files:
        docfx.yml: |
          dependencies:
            restore-child1: https://docs.com/restore/x#child
            restore-child2: https://docs.com/restore/x#child-a
        docs/a.md: |
          [!include[](~/restore-child1/docs/child.md)]
  https://docs.com/restore/x#child:
    - files:
        docs/child.md:
  https://docs.com/restore/x#child-a:
    - files:
        docs/childx.md:
outputs:
  docs/a.json:
---
# restore with dependency lock
# TODO: always get latest version for dependency without lock
repos:
  https://docs.com/lock1/a#master:
    - files:
        docfx.yml: |
          dependencies:
            dep1: https://docs.com/lock1/b#master
            dep2: https://docs.com/lock1/c
          dependencyLock: .lock.json
        docs/a.md: |
          [!include[](~/dep1/docs/dep1.md)]
          [!include[](~/dep2/docs/dep2.md)]
        .lock.json: |
          {  
             "git":{  
                "https://docs.com/lock1/b":{  
                   "commit":"6a7b7f142f2de52a0b488309f4257d462956f59f",
                   "git":{  
                      "https://docs.com/lock1/c#master":{  
                         "commit":"8720d784fb99abcbdfa922025b8bcc060f0f622a"
                      }
                   }
                },
                "https://docs.com/lock1/c#master": {
                  "commit": "c5969737496ff42854a019f982882d5fac486a56"
                }
             }
          }
  https://docs.com/lock1/b:
    - files:
        docs/dep1.md: |
          "abc"
          [!include[](~/dep2/docs/dep2.md)]
        docfx.yml: |
          dependencies:
            dep2: https://docs.com/lock1/c
    - files:
        docs/dep1.md: |
          "def"
          [!include[](~/dep2/docs/dep2.md)]
        docfx.yml: |
          dependencies:
            dep2: https://docs.com/lock1/c
  https://docs.com/lock1/c:
    - files:
        docs/dep2.md: "2333"
    - files:
        docs/dep2.md: "233333"
outputs:
  docs/a.json: |
    {"content":"<p>&quot;def&quot;</p>\n<p>233333</p>\n<p>2333</p>\n"}
  ~/.lock.json: |
    {
       "git":{
          "https://docs.com/lock1/c#master":{
             "commit":"c5969737496ff42854a019f982882d5fac486a56"
          },
          "https://docs.com/lock1/b#master":{
             "git":{
                "https://docs.com/lock1/c#master":{
                   "commit":"8720d784fb99abcbdfa922025b8bcc060f0f622a"
                }
             },
             "!downloads": null,
             "commit":"6a7b7f142f2de52a0b488309f4257d462956f59f"
          }
       },
       "!downloads": null
    }
---
# restore with azure repo dependency lock
repos:
  https://docascode.visualstudio.com/lock/_git/a:
    - files:
        docfx.yml: |
          dependencies:
            dep1: https://docascode.visualstudio.com/lock/_git/b#master
            dep2: https://docascode.visualstudio.com/lock/_git/c
          dependencyLock: .lock.json
        docs/a.md: |
          [!include[](~/dep1/docs/dep1.md)]
          [!include[](~/dep2/docs/dep2.md)]
        .lock.json: |
          {  
             "git":{  
                "https://docascode.visualstudio.com/lock/_git/b":{
                   "commit":"921c49b9f8d6889d36d8aadc570922462963348d",
                   "git":{  
                      "https://docascode.visualstudio.com/lock/_git/c#master":{
                         "commit":"8720d784fb99abcbdfa922025b8bcc060f0f622a"
                      }
                   }
                },
                "https://docascode.visualstudio.com/lock/_git/c#master": {
                  "commit": "c5969737496ff42854a019f982882d5fac486a56"
                }
             }
          }
  https://docascode.visualstudio.com/lock/_git/b:
    - files:
        docs/dep1.md: |
          "abc"
          [!include[](~/dep2/docs/dep2.md)]
        docfx.yml: |
          dependencies:
            dep2: https://docascode.visualstudio.com/lock/_git/c
    - files:
        docs/dep1.md: |
          "def"
          [!include[](~/dep2/docs/dep2.md)]
        docfx.yml: |
          dependencies:
            dep2: https://docascode.visualstudio.com/lock/_git/c
  https://docascode.visualstudio.com/lock/_git/c:
    - files:
        docs/dep2.md: "2333"
    - files:
        docs/dep2.md: "233333"
outputs:
  docs/a.json: |
    {"content":"<p>&quot;def&quot;</p>\n<p>233333</p>\n<p>2333</p>\n"}
  ~/.lock.json: |
    {
       "git":{
          "https://docascode.visualstudio.com/lock/_git/c#master":{
             "commit":"c5969737496ff42854a019f982882d5fac486a56"
          },
          "https://docascode.visualstudio.com/lock/_git/b#master":{
             "git":{
                "https://docascode.visualstudio.com/lock/_git/c#master":{
                   "commit":"8720d784fb99abcbdfa922025b8bcc060f0f622a"
                }
             },
             "!downloads": null,
             "commit":"921c49b9f8d6889d36d8aadc570922462963348d"
          }
       },
       "!downloads": null
    }
---
# restore with sub dependency lock only, sub dependency lock doesn't work
repos:
  https://docs.com/lock2/a#master:
    - files:
        docfx.yml: |
          dependencies:
            dep1: https://docs.com/lock2/b#master
          dependencyLock: .non-exist.json
        docs/a.md: |
          [!include[](~/dep1/docs/dep1.md)]
  https://docs.com/lock2/b:
    - files:
        docs/dep1.md: |
          "abc"
          [!include[](~/dep2/docs/dep2.md)]
        docfx.yml: |
          dependencies:
            dep2: https://docs.com/lock2/c
          dependencyLock: .lock.json
        .lock.json: |
          {
             "git":{
                "https://docs.com/lock2/c#master":{
                   "commit":"8720d784fb99abcbdfa922025b8bcc060f0f622a"
                }
             }
          }
    - files:
        docs/dep1.md: |
          "def"
          [!include[](~/dep2/docs/dep2.md)]
        docfx.yml: |
          dependencies:
            dep2: https://docs.com/lock2/c
  https://docs.com/lock2/c:
    - files:
        docs/dep2.md: "2333"
    - files:
        docs/dep2.md: "233333"
outputs:
  docs/a.json: |
    {"content":"<p>&quot;abc&quot;</p>\n<p>2333</p>"}
  ~/.non-exist.json: |
    {
      "git": {
        "https://docs.com/lock2/b#master": {
          "git": {
            "https://docs.com/lock2/c#master": {
              "commit": "c5969737496ff42854a019f982882d5fac486a56"
            }
          },
          "!downloads": null,
          "commit": "71ac1c4ce676987be5f15bffb7c97515adec5450"
        }
      },
      "!downloads": null
    }
---
# restore with root and sub dependency lock, root lock wins
repos:
  https://docs.com/lock3/a#master:
    - files:
        docfx.yml: |
          dependencies:
            dep1: https://docs.com/lock3/b#master
          dependencyLock: .lock.json
        docs/a.md: |
          [!include[](~/dep1/docs/dep1.md)]
        .lock.json: |
          {  
             "git":{  
                "https://docs.com/lock3/b":{  
                   "git":{  
                      "https://docs.com/lock3/c#master":{  
                         "commit":"c5969737496ff42854a019f982882d5fac486a56"
                      }
                   }
                }
             }
          }
  https://docs.com/lock3/b:
    - files:
        docs/dep1.md: |
          "abc"
          [!include[](~/dep2/docs/dep2.md)]
        docfx.yml: |
          dependencies:
            dep2: https://docs.com/lock3/c
          dependencyLock: .lock.json
        .lock.json: |
          {
             "git":{
                "https://docs.com/lock3/c#master":{
                   "commit":"8720d784fb99abcbdfa922025b8bcc060f0f622a"
                }
             }
          }
    - files:
        docs/dep1.md: |
          "def"
          [!include[](~/dep2/docs/dep2.md)]
        docfx.yml: |
          dependencies:
            dep2: https://docs.com/lock3/c
  https://docs.com/lock3/c:
    - files:
        docs/dep2.md: "2333"
    - files:
        docs/dep2.md: "233333"
outputs:
  docs/a.json: |
    {"content":"<p>&quot;abc&quot;</p>\n<p>2333</p>"}
  ~/.lock.json: |
    {
      "git": {
        "https://docs.com/lock3/b#master": {
          "git": {
            "https://docs.com/lock3/c#master": {
              "commit": "c5969737496ff42854a019f982882d5fac486a56"
            },
            "!downloads": null
          },
          "commit": "8b8e7ce24bfddb4ad489dd96ab00b10d0ba50bf3"
        }
      },
      "!downloads": null
    }
