# Redirection file content type invalid
inputs:
  docfx.yml:
  redirections.yml: |
    redirections:
      docs/toc.md: /absolute/path
outputs:
  .errors.log: |
    {"message_severity":"error","code":"redirection-invalid","message":"File 'docs/toc.md' is redirected to '/absolute/path'. Only content files can be redirected.","file":"redirections.yml","line":2,"column":16}
---
# Redirection url conflict
inputs:
  docfx.yml:
  redirections.yml: |
    renames:
      docs/a.md: /docs/b
    redirections:
      docs/a.md: /absolute/path2
  docs/b.md:
outputs:
  docs/b.json:
  .errors.log: |
    {"message_severity":"error","code":"redirection-conflict","message":"The 'docs/a.md' appears twice or more in the redirection mappings.","file":"redirections.yml","line":4,"column":14}
---
# Redirection file out of build scope
inputs:
  docfx.yml: |
    exclude: '*'
  redirections.yml: |
    redirections:
      docs/a.md: /absolute/path1
      b.md: /absolute/path2
outputs:
---
# Redirection file out of build scope with conflicted id
inputs:
  docfx.yml: |
    exclude: '*'
  redirections.yml: |
    redirections:
      a.md: /absolute/path1
      b.md: /absolute/path1
outputs:
---
# Multiple redirection errors
inputs:
  docfx.yml:
  redirections.yml: |
    renames:
      docs/toc.md: /absolute/path
      docs/a.md: /docs/b
    redirections:
      docs/a.md: /absolute/path2
  docs/b.md:
outputs:
  docs/b.json:
  .errors.log: |
    {"message_severity":"error","code":"redirection-invalid","message":"File 'docs/toc.md' is redirected to '/absolute/path'. Only content files can be redirected.","file":"redirections.yml","line":2,"column":16}
    {"message_severity":"error","code":"redirection-conflict","message":"The 'docs/a.md' appears twice or more in the redirection mappings.","file":"redirections.yml","line":5,"column":14}
---
# redirect to not starting with '/' is allowed in config.redirectionWithoutIds
inputs:
  docfx.yml:
  redirections.yml: |
    redirections:
      a.md: https://docs.microsoft.com/docfx/a
      b.md: a
outputs:
---
# redirect to can start with https and hostname
inputs:
  docfx.yml: |
    hostName: docs.microsoft.com
  b.md:
  redirections.yml: |
    renames:
      a.md: https://docs.microsoft.com/b
outputs:
  b.json: |
   {"document_id": "65b4ee15-e7e4-88ee-72ec-7be7d0bcd895", "document_version_independent_id": "65b4ee15-e7e4-88ee-72ec-7be7d0bcd895"}
---
# redirect to can start with https and hostname with locale
# output document_id and canonical_url for redirection file as well
# query string will be ignored for redirect document id calculation
inputs:
  docfx.yml:
  b.md:
  redirections.yml: |
    renames:
      a.md: https://docs.com/en-us/b?query#fragment
outputs:
  .publish.json: |
    {"files":[
      {"url":"/a", "document_id":"65b4ee15-e7e4-88ee-72ec-7be7d0bcd895", "canonical_url": "https://docs.com/en-us/a", "document_version_independent_id": "65b4ee15-e7e4-88ee-72ec-7be7d0bcd895"}, 
      {"url":"/b", "document_id":"65b4ee15-e7e4-88ee-72ec-7be7d0bcd895"}
    ]}
  b.json: |
   {"document_id": "65b4ee15-e7e4-88ee-72ec-7be7d0bcd895", "document_version_independent_id": "65b4ee15-e7e4-88ee-72ec-7be7d0bcd895"}
---
# Redirection files have conflicted ids
# all redirection files will be built
# redirection document id is retrieved from the first redirection file (a.md for below case)
inputs:
  docfx.yml:
  redirections.yml: |
    renames:
      a.md: /docs/path1
      b.md: /docs/path1
  docs/path1.md:
outputs:
  .errors.log: |
    {"message_severity":"warning","code":"redirection-url-conflict","message":"The following files are redirected to '/docs/path1' with redirect_document_id set to true: 'a.md', 'b.md'. Only one file can have its document ID redirected to each redirect_url. Change all but one instance to false in redirection file(s): 'redirections.yml'.","file":"redirections.yml","line":2,"column":9}
  .publish.json: |
    {
        "files": [
            { "url": "/a" },
            { "url": "/b" },
            { "url": "/docs/path1" }
        ]
    }
  docs/path1.json: |
    {"document_id": "65b4ee15-e7e4-88ee-72ec-7be7d0bcd895", "document_version_independent_id": "65b4ee15-e7e4-88ee-72ec-7be7d0bcd895",}
---
# generate same document id and version id with 'redirection with document id'
# A => B, B's ids should be same with A's
inputs:
  docsets.yml:
  docs/docfx.yml: |
    hostName: docs.com
    basePath: /docs
    routes:
      docs/: .
  docs/redirections.yml: |
    renames:
      a.md: /docs/x
      b.md: /docs/y?query=value#bookmark
      c.md: /docs/folder1/index
      d.md: /docs/folder2/
      e.md: /docs/z
      f.md: /docs/e
  docs/x.md:
  docs/y.md:
  docs/z.md:
  docs/folder1/index.md:
  docs/folder2/index.md:
outputs:
  docs/docs/x.json: |
    { "document_id": "65b4ee15-e7e4-88ee-72ec-7be7d0bcd895", "document_version_independent_id": "65b4ee15-e7e4-88ee-72ec-7be7d0bcd895" }
  docs/docs/y.json: |
    { "document_id": "e8d868e6-7373-19e3-7d3e-0fa0d3399631", "document_version_independent_id": "e8d868e6-7373-19e3-7d3e-0fa0d3399631" }
  docs/docs/z.json: |
    { "document_id": "987192db-0662-64c5-30b8-083880a86f70", "document_version_independent_id": "987192db-0662-64c5-30b8-083880a86f70" }
  docs/docs/folder1/index.json: |
    { "document_id": "d4c1d336-d9a7-3b5c-e27f-b8c630a6d5c2", "document_version_independent_id": "d4c1d336-d9a7-3b5c-e27f-b8c630a6d5c2" }
  docs/docs/folder2/index.json: |
    { "document_id": "39a9019a-f76b-99af-35b6-d788e72e9fd3", "document_version_independent_id": "39a9019a-f76b-99af-35b6-d788e72e9fd3" }
---
# generate different document id and version id with 'redirection without document id'
inputs:
  docsets.yml:
  sccm/docfx.yml: |
    name: sccm
    product: Win
    files: "**/*"
    hostName: docs.com
    basePath: /sccm
  redirections.yml: |
    redirections:
      sccm/mdm/index.md: /sccm/mdm/understand/hybrid-mobile-device-management
  sccm/mdm/understand/hybrid-mobile-device-management.md:
outputs:
  sccm/sccm/mdm/understand/hybrid-mobile-device-management.json: |
    { "document_id": "b1262230-a66f-fae9-2699-da54c87c6939", "document_version_independent_id": "b1262230-a66f-fae9-2699-da54c87c6939" }
---
# redirect with document id resolve relative redirect_url
# publish item's redirect_url keeps user's input
inputs:
  docsets.yml:
  develop/docfx.yml: |
    name: partner-center-sdk
    product: MSDN
    hostName: docs.com
    basePath: /partner-center-sdk
  develop/redirections.yml: |
    renames:
      agreement-metadata.md: agreement-metadata-resources
  develop/agreement-metadata-resources.md:
outputs:
  develop/partner-center-sdk/agreement-metadata-resources.json: |
    { "document_id": "5cbc74e1-881b-b4bf-4d40-f6b2710b55e8", "document_version_independent_id": "5cbc74e1-881b-b4bf-4d40-f6b2710b55e8" }
  develop/.publish.json: |
    {
      "files": [
          {
              "url": "/partner-center-sdk/agreement-metadata",              
              "locale": "en-us",
              "redirect_url": "/partner-center-sdk/agreement-metadata-resources"
          },
          {
              "url": "/partner-center-sdk/agreement-metadata-resources",
              "path": "partner-center-sdk/agreement-metadata-resources.json",
              "source_path": "agreement-metadata-resources.md",
              "locale": "en-us"
          }
      ]
    }
---
# Show warning if two or more files redirect to the same file with document id
noSingleFile: true
inputs:
  docsets.yml:
  sccm/docfx.yml: |
    name: sccm
    product: Win
    files: "**/*"
    hostName: docs.com
    basePath: /sccm
  sccm/redirections.yml: |
    renames:
      mdm/index.md: /sccm/mdm/understand/hybrid-mobile-device-management
      mdm/index2.md: /sccm/mdm/understand/hybrid-mobile-device-management
  sccm/mdm/understand/hybrid-mobile-device-management.md:
outputs:
  sccm/sccm/mdm/understand/hybrid-mobile-device-management.json: |
    { "document_id": "ef9b84bd-be67-f99d-6b01-58ea46745404", "document_version_independent_id": "ef9b84bd-be67-f99d-6b01-58ea46745404" }
  .errors.log: |
    {"message_severity":"warning","code":"redirection-url-conflict","message":"The following files are redirected to '/sccm/mdm/understand/hybrid-mobile-device-management' with redirect_document_id set to true: 'mdm/index.md', 'mdm/index2.md'. Only one file can have its document ID redirected to each redirect_url. Change all but one instance to false in redirection file(s): 'redirections.yml'.","line":2,"column":17}
---
# redirect to empty URL
inputs:
  docfx.yml:
  redirections.yml: |
    redirections:
      sccm/mdm/index.md: ""
      "": /docfx/test
      a.md:
outputs:
  .errors.log: |
    {"message_severity":"warning","code":"missing-attribute","message":"Missing required attribute: '(source_path or source_path_from_root) or redirect_url'.","file":"redirections.yml","line":2,"column":22}
    {"message_severity":"warning","code":"missing-attribute","message":"Missing required attribute: '(source_path or source_path_from_root) or redirect_url'.","file":"redirections.yml","line":3,"column":7}
    {"message_severity":"warning","code":"missing-attribute","message":"Missing required attribute: '(source_path or source_path_from_root) or redirect_url'.","file":"redirections.yml","line":4,"column":8}
---
# The dest to redirection url does not match any files's publish URL, but the redirect_with_id flag has been set as true
inputs:
  docfx.yml:
  redirections.yml: |
    renames:
      docs/a.md: "/docs/x"
      docs/c.md: "/docs/x#bookmark"
      docs/b.md: "http://hostname/test"
      docs/d.md: "/docs/folder0"
      docs/f.md: "/docs/folder0/"
      docs/h.md: "/docs/folder0/index"
outputs:
  .errors.log: |
    {"message_severity":"suggestion","code":"redirect-url-invalid","message":"Can't redirect document ID for redirected file 'docs/b.md' because redirect URL 'http://hostname/test' is invalid or is in a different docset. Specify a redirect_url in the same docset, or set redirect_document_id to false in .openpublishing.redirection.json.","file":"redirections.yml","line":4,"column":14}
    {"message_severity":"suggestion","code":"redirect-url-invalid","message":"Can't redirect document ID for redirected file 'docs/a.md' because redirect URL '/docs/x' is invalid or is in a different docset. Specify a redirect_url in the same docset, or set redirect_document_id to false in .openpublishing.redirection.json.","file":"redirections.yml","line":2,"column":14}
    {"message_severity":"suggestion","code":"redirect-url-invalid","message":"Can't redirect document ID for redirected file 'docs/c.md' because redirect URL '/docs/x#bookmark' is invalid or is in a different docset. Specify a redirect_url in the same docset, or set redirect_document_id to false in .openpublishing.redirection.json.","file":"redirections.yml","line":3,"column":14}
    {"message_severity":"suggestion","code":"redirect-url-invalid","message":"Can't redirect document ID for redirected file 'docs/d.md' because redirect URL '/docs/folder0' is invalid or is in a different docset. Specify a redirect_url in the same docset, or set redirect_document_id to false in .openpublishing.redirection.json.","file":"redirections.yml","line":5,"column":14}
    {"message_severity":"suggestion","code":"redirect-url-invalid","message":"Can't redirect document ID for redirected file 'docs/f.md' because redirect URL '/docs/folder0/' is invalid or is in a different docset. Specify a redirect_url in the same docset, or set redirect_document_id to false in .openpublishing.redirection.json.","file":"redirections.yml","line":6,"column":14}
    {"message_severity":"suggestion","code":"redirect-url-invalid","message":"Can't redirect document ID for redirected file 'docs/h.md' because redirect URL '/docs/folder0/index' is invalid or is in a different docset. Specify a redirect_url in the same docset, or set redirect_document_id to false in .openpublishing.redirection.json.","file":"redirections.yml","line":7,"column":14}
  .publish.json: |
    {
      "files": [
        { "redirect_url": "/docs/x" },
        { "redirect_url": "http://hostname/test" },
        { "redirect_url": "/docs/x#bookmark" },
        { "redirect_url": "/docs/folder0" },
        { "redirect_url": "/docs/folder0/" },
        { "redirect_url": "/docs/folder0/index" }
      ]
    }
---
# generate document id with depot mapping and directory mapping
# id = hash({mapped_depot_name}|{mapped_file_in_docset})
# version_independent_id = hash({mapped_depot_name}|{file_path})
inputs:
  docfx.yml: |
    documentId:
      articles/iot-central/:
        depot_name: MSDN.microsoft-iot-central
        folder_relative_path_in_docset: articles
      articles\billing/billing-add-change-azure-subscription-administrator.md:
        folder_relative_path_in_docset: articles
    name: azure-documents
    product: Azure
    hostName: docs.com
    basePath: /azure
    routes:
      articles/: .
  articles/iot-central/concepts-architecture.md:
  articles/billing/billing-add-change-azure-subscription-administrator.md:
outputs:
  azure/iot-central/concepts-architecture.json: |
    {"document_id":"4f9b7c5f-a3d3-c4c8-c533-685fef3d75cf","document_version_independent_id":"24400b27-bf0c-f16d-7b4c-b21819f60407"}
  azure/billing/billing-add-change-azure-subscription-administrator.json: |
    {"document_id":"73a45eb0-5b21-66af-18b2-b707dba52dbc","document_version_independent_id":"8e40db88-d503-1336-b784-1c2d911b759f"}
---
# generate document id with _op_documentIdPathDepotMapping config
inputs:
  docsets.yml:
  articles/docfx.yml: |
    globalMetadata:
      _op_documentIdPathDepotMapping:
        retail/:
          depot_name: MSDN.d365OpsRetail
          folder_relative_path_in_docset: .
    name: d365F-O-ppe
    product: Azure
  articles/retail/analyze-sales-trends-patterns.md:
outputs:
  articles/retail/analyze-sales-trends-patterns.json: |
    { "document_id":"09504273-41ab-d809-83e4-3d4ec98ca7cf" }
---
# document_id of _op_documentIdPathDepotMapping without folder_relative_path_in_docset
inputs:
  docfx.yml: |
    globalMetadata:
      _op_documentIdPathDepotMapping:
        ./:
          depot_name: Azure.azure-documents
  articles/active-directory/active-directory-conditional-access-azure-portal.md:
outputs:
  articles/active-directory/active-directory-conditional-access-azure-portal.json: |
    { "document_id":"a05033b3-b1a3-fdd6-0bd1-82262ffb11c2" }
---
# redirect to redirect
inputs:
  docfx.yml: |
    name: azure-documents
    product: Azure
    files: "**/*"
    hostName: docs.com
    basePath: /azure
    routes:
      articles/: .
  redirections.yml: |
    renames:
      articles/active-directory/active-directory-saas-splunkenterpriseandsplunkcloud-tutorial.md: /azure/active-directory/saas-apps/splunkenterpriseandsplunkcloud-tutorial
      articles/active-directory/active-directory-saas-splunk-enterprise-and-splunk-cloud-tutorial.md: /azure/active-directory/active-directory-saas-splunkenterpriseandsplunkcloud-tutorial
  articles/active-directory/saas-apps/splunkenterpriseandsplunkcloud-tutorial.md:
outputs:
  azure/active-directory/saas-apps/splunkenterpriseandsplunkcloud-tutorial.json: |
    {"document_id":"850c3685-7e21-1f26-01ef-75c76237d368","document_version_independent_id":"06f8b36b-dd59-c7e1-2595-263b1c25f39d"}
---
# landing page is treated as *.md when calculating document id
# id: 
#   new Guid(md5.ComputeHash(new MemoryStream(Encoding.UTF8.GetBytes("Azure.azure-documents|articles/active-directory-b2c/*.md")))).ToString()
# document_version_independent_id : 
#   new Guid(md5.ComputeHash(new MemoryStream(Encoding.UTF8.GetBytes("Azure.azure-documents|active-directory-b2c/*")))).ToString()
inputs:
  docfx.yml: |
    product: Azure
    name: azure-documents
    files: "**/*"
    hostName: docs.com
    basePath: /azure
    routes:
      articles/: .
  articles/active-directory-b2c/index.yml : |
    ### YamlMime:YamlDocument
    documentType: LandingData
  articles/active-directory-b2c/test.yml : |
    ### YamlMime:YamlDocument
    documentType: LandingData
outputs:
  azure/active-directory-b2c/index.json: |
    {"metadata": { "document_id": "25e3a02b-c9bc-78d0-0c60-2f9bda486b6d", "document_version_independent_id": "a24127ae-2f3f-faa7-5365-9feb16012387"}}
  azure/active-directory-b2c/test.json: |
    {"metadata": { "document_id": "440e6a2a-1ccd-e1b4-d47b-b67c16b60f11", "document_version_independent_id": "4e937130-f914-6b33-76e3-7d81de81e7b6"}}
---
# Hub/Landing/Architecture/FAQ page is treated as *.md when calculating document id
os: windows, osx
inputs:
  docfx.yml: |
    product: Azure
    name: azure-documents
    files: "**/*"
    hostName: docs.com
    basePath: /azure
    routes:
      articles/: .
  articles/active-directory-b2c/index.yml : |
    ### YamlMime:Hub
  articles/active-directory-b2c/test.yml : |
    ### YamlMime:landing
  articles/active-directory-b2c/architecture.yml : |
    ### YamlMime:Architecture
  articles/active-directory-b2c/faq.yml : |
    ### YamlMime:FAQ
  _themes/ContentTemplate/schemas/Hub.schema.json:
  _themes/ContentTemplate/Hub.html.primary.tmpl:
  _themes/ContentTemplate/schemas/Landing.schema.json:
  _themes/ContentTemplate/Landing.html.primary.tmpl:
  _themes/ContentTemplate/schemas/Architecture.schema.json:
  _themes/ContentTemplate/Architecture.html.primary.tmpl:
  _themes/ContentTemplate/schemas/FAQ.schema.json:
  _themes/ContentTemplate/FAQ.html.primary.tmpl:
outputs:
  azure/active-directory-b2c/index.json: |
    {"metadata": { "document_id": "25e3a02b-c9bc-78d0-0c60-2f9bda486b6d", "document_version_independent_id": "a24127ae-2f3f-faa7-5365-9feb16012387"}}
  azure/active-directory-b2c/test.json: |
    {"metadata": { "document_id": "440e6a2a-1ccd-e1b4-d47b-b67c16b60f11", "document_version_independent_id": "4e937130-f914-6b33-76e3-7d81de81e7b6"}}
  azure/active-directory-b2c/architecture.json: |
    {"metadata": { "document_id": "315b16be-b4f4-9ba7-bc6f-9199068cfe5a", "document_version_independent_id": "f34cdd38-f26d-6997-799a-23c991e26acb"}}
  azure/active-directory-b2c/faq.json: |
    {"metadata": { "document_id": "7e2f5500-4422-6041-7f3a-d1d4cfcb8284", "document_version_independent_id": "79d0efd7-d86c-57f7-55dc-90a2b474bbbd"}}
---
# index.yml's document id also follows the redirection rules
# trailing 'index' redirect-to will be trimmed
inputs:
  docfx.yml: |
    product: Azure
    name: azure-documents
    files: "**/*"
    hostName: docs.com
    basePath: /azure
    routes:
      articles/: .
  redirections.yml: |
    renames:
      articles/virtual-machines/windows/classic/web-app-visual-studio.md: /azure/app-service/index
  articles/app-service/index.yml : |
    ### YamlMime:YamlDocument
    documentType: LandingData
outputs:
  azure/app-service/index.json: |
    {"metadata":{ "document_id": "a48fa51e-c7c7-f631-d8be-57627e541c8a", "document_version_independent_id": "1e2f77f0-b332-39ea-1d22-e06f34333899"}}
---
# redirection defined in markdown yaml metadata is not supported
noSingleFile: true
inputs:
  docfx.yml:
  redirections.yml: |
    redirections:
      docs/a.md: /a
  docs/a.md:
  docs/b.md: |
    ---
    redirect_url: https://docfx.com/c
    ---
outputs:
  docs/b.json:
  .errors.log: |
    {"message_severity":"warning","code":"attribute-reserved","message":"Attribute redirect_url is reserved for use by Docs.","file":"docs/b.md","line":2,"column":1}
    {"message_severity":"warning","code":"redirected-file-not-removed"}
---
# document_id of .yml redirections are calculated as .md
inputs:
  docfx.yml:
  redirections.yml: |
    renames:
      a.yml: /b
  b.md:
outputs:
  b.json: |
    { "document_id": "65b4ee15-e7e4-88ee-72ec-7be7d0bcd895" }
---
# Support redirect_url ends with '/' for index files
repos:
  https://docs.com/ops/redirect-3:
  - files:
      redirections.json: |
        {
          "redirections": [
            {
              "source_path": "original.md",
              "redirect_url": "https://docs.com/folder/",
              "redirect_document_id": "true"
            }
          ]
        }
      docfx.yml: |
        name: docset
        product: product
      folder/index.md:
outputs:
  folder/index.json: |
    { "document_id": "6172869a-1d42-80e4-5d0c-707167a0d4c1" }
---
# Handle circular redirection with document id
repos:
  https://docs.com/ops/redirect-4:
  - files:
      docfx.yml:
      redirections.json: |
        {
          "redirections": [
            {
              "source_path": "a.md",
              "redirect_url": "/a",
              "redirect_document_id": true
            },
            {
              "source_path": "b.md",
              "redirect_url": "/b",
              "redirect_document_id": true
            }
          ]
        }
      a.md:
outputs:
  .publish.json: |
    {
      "files": [
          { "url": "/a", "redirect_url": "/a" },
          { "url": "/b", "redirect_url": "/b" }
      ]
    }
  .errors.log: |
    {"message_severity":"warning","code":"circular-redirection","message":"Build has identified circular redirection: a.md [redirection] --> a.md [redirection].","file":"redirections.json","line":5,"column":26}
    {"message_severity":"warning","code":"circular-redirection","message":"Build has identified circular redirection: b.md [redirection] --> b.md [redirection].","file":"redirections.json","line":10,"column":26}
    {"message_severity":"warning","code":"redirected-file-not-removed"}
---
# Warn on circular redirection without document id
inputs:
  docfx.yml:
  redirections.yml: |
    redirections:
      a.md: /b
      b.md: /c
      c.md: /a
outputs:
  .errors.log: |
    {"message_severity":"warning","code":"circular-redirection","message":"Build has identified circular redirection: a.md [redirection] --> b.md [redirection] --> c.md [redirection] --> a.md [redirection].","file":"redirections.yml","line":2,"column":9}
    {"message_severity":"warning","code":"circular-redirection","message":"Build has identified circular redirection: b.md [redirection] --> c.md [redirection] --> a.md [redirection] --> b.md [redirection].","file":"redirections.yml","line":3,"column":9}
    {"message_severity":"warning","code":"circular-redirection","message":"Build has identified circular redirection: c.md [redirection] --> a.md [redirection] --> b.md [redirection] --> c.md [redirection].","file":"redirections.yml","line":4,"column":9}
---
# Versioning file redirection to url of non-versioning file
inputs:
  docfx.yml: |
    monikerRange:
      'docs/v1/**': '< netcore-2.0'
    hostName: docs.com
    basePath: /docs
    routes:
      docs/: .
      docs/v1/: .
    monikerDefinition: monikerDefinition.json
  redirections.yml: |
    redirections:
      docs/v1/c.md: /docs/test/a
  docs/test/a.md:
  monikerDefinition.json: |
    {
      "monikers": [
        { "moniker_name": "netcore-1.0", "product_name": ".NET Core" },
        { "moniker_name": "netcore-1.1", "product_name": ".NET Core" },
        { "moniker_name": "netcore-2.0", "product_name": ".NET Core" },
        { "moniker_name": "netcore-2.1", "product_name": ".NET Core" }
      ]
    }
outputs:
    docs/test/a.json:
---
# No warning for self redirection to url with version
inputs:
  docfx.yml: |
    monikerRange:
      'docs/v1/**': '< netcore-1.0'
    hostName: docs.com
    basePath: /docs
    routes:
      docs/: .
      docs/v1/: .
    monikerDefinition: monikerDefinition.json
  redirections.yml: |
    redirections:
      docs/v1/c.md: /docs/c?view=netcore2.0
    renames:
      docs/v1/d.md: /docs/d?view=netcore2.0
  monikerDefinition.json: |
    {
      "monikers": [
        { "moniker_name": "netcore-1.0", "product_name": ".NET Core" },
        { "moniker_name": "netcore-1.1", "product_name": ".NET Core" },
        { "moniker_name": "netcore-2.0", "product_name": ".NET Core" },
        { "moniker_name": "netcore-2.1", "product_name": ".NET Core" }
      ]
    }
outputs:
---
# Support monikers for redirection
repos:
  https://github.com/redirection/source-monikers:
  - files:
      docfx.yml: |
        monikerDefinition: monikerDefinition.json
      .openpublishing.redirection.json: |
        { 
          "redirections": [
            {"source_path": "a.md", "monikers": ["netcore-1.0", "netcore-2.0"], "redirect_URL": "/b"}, 
            {"source_path": "a.md", "monikers": "netcore-2.1", "redirect_URL": "/c"}]
         }
      monikerDefinition.json: |
        {
          "monikers": [
            { "moniker_name": "netcore-1.0", "product_name": ".NET Core" },
            { "moniker_name": "netcore-1.1", "product_name": ".NET Core" },
            { "moniker_name": "netcore-2.0", "product_name": ".NET Core" },
            { "moniker_name": "netcore-2.1", "product_name": ".NET Core" }
          ]
        }
outputs:
  .publish.json: |
    { 
      "files": 
        [
          { "redirect_url": "/c", "moniker_group": "21903d6cbe60219e3923dd4fa60a8a63" },
          { "redirect_url": "/b", "moniker_group": "78a0a559ed7f8a30d90c683a57012297" }
        ]
    }
  filemap.json: |
    {
      "file_mapping": 
        {
            "a.md:78a0a559ed7f8a30d90c683a57012297": {
                "type": "Content",
                "output_relative_path": "78a0a559ed7f8a30d90c683a57012297/a.html",
                "asset_id": "a",
                "monikers": [
                    "netcore-1.0",
                    "netcore-2.0"
                ]
            },
            "a.md:21903d6cbe60219e3923dd4fa60a8a63": {
                "type": "Content",
                "output_relative_path": "21903d6cbe60219e3923dd4fa60a8a63/a.html",
                "asset_id": "a",
                "monikers": [
                    "netcore-2.1"
                ]
            }
        }
    }
---
# Redirection with overlapping monikers
repos:
  https://github.com/redirection/source-monikers-overlapping:
  - files:
      docfx.yml: |
        monikerDefinition: monikerDefinition.json
      .openpublishing.redirection.json: |
        { 
          "redirections": [
            {"source_path": "a.md", "monikers": ["netcore-1.0", "netcore-2.0"], "redirect_URL": "/b"}, 
            {"source_path": "a.md", "monikers": "netcore-2.0", "redirect_URL": "/c"}]
         }
      monikerDefinition.json: |
        {
          "monikers": [
            { "moniker_name": "netcore-1.0", "product_name": ".NET Core" },
            { "moniker_name": "netcore-1.1", "product_name": ".NET Core" },
            { "moniker_name": "netcore-2.0", "product_name": ".NET Core" },
            { "moniker_name": "netcore-2.1", "product_name": ".NET Core" }
          ]
        }
outputs:
  .errors.log: |
    {"message_severity":"warning","code":"publish-url-conflict","message":"Two or more files of the same version('netcore-2.0') publish to the same url '/a': 'a.md [redirection][netcore-1.0, netcore-2.0]<'netcore-1.0', 'netcore-2.0'>', 'a.md [redirection][netcore-2.0]<'netcore-2.0'>'.","line":0,"column":0}
  .publish.json: |
    {
      "files": [
        {
          "url": "/a",
          "moniker_group": "ecc061f43156f37be077db42abf8301a",
          "locale": "en-us",
          "redirect_url": "/c",
        }
      ]
    }
---
# There is no 'source-path' defined for 'redirect_url': '/'
repos:
  https://docs.com/ops/redirect-1:
  - files:
      docfx.yml:
      .openpublishing.redirection.json: |
        { "redirections": [{"redirect_url": "/"}] }
outputs:
  .publish.json:
  .errors.log: |
    {"message_severity":"warning","code":"missing-attribute","message":"Missing required attribute: '(source_path or source_path_from_root) or redirect_url'.","line":1,"column":39}
---
# The 'sourth-path' and 'redirect-url' are both null
repos:
  https://docs.com/ops/redirect-2:
  - files:
      docfx.yml:
      .openpublishing.redirection.json: |
        { "redirections": [{}] }
outputs:
  .publish.json:
  .errors.log: |
    {"message_severity":"warning","code":"missing-attribute","message":"Missing required attribute: '(source_path or source_path_from_root) or redirect_url'.","line":0,"column":0}
---
# exclude_monikers should take effect on config monikers as well
repos:
  https://github.com/redirection/source-monikers:
  - files:
      docfx.yml: |
        monikerRange:
          'docs/v1/**': '>= netcore-1.0'
        monikerDefinition: monikerDefinition.json
        fileMetadata:
          exclude_monikers:
            '**/*.md': 
            - netcore-2.0
      docs/v1/a.md:
      .openpublishing.redirection.json: |
        { 
          "redirections": [{"source_path": "docs/v1/a.md", "monikers": "netcore-2.0", "redirect_URL": "/b"}]
        }
      monikerDefinition.json: |
        {
          "monikers": [
            { "moniker_name": "netcore-1.0", "product_name": ".NET Core" },
            { "moniker_name": "netcore-1.1", "product_name": ".NET Core" },
            { "moniker_name": "netcore-2.0", "product_name": ".NET Core" },
            { "moniker_name": "netcore-2.1", "product_name": ".NET Core" }
          ]
        }
outputs:
  7754eee8fd33b34bfa2a814cd5e27e96/docs/v1/a.json:
---
# Multiple Redirection Files
repos:
  https://github.com/redirection/multiple-redirection-files:
  - files:
      .openpublishing.publish.config.json: |
        {
          "docsets_to_publish": [{"build_source_folder":"a"}],
          "redirection_files": [
            ".openpublishing.redirection.json",
            ".openpublishing.redirection.test.json",
            "a/.openpublishing.redirection.test.json",
            "a/b/.openpublishing.redirection.json"
          ],
        }
      .openpublishing.redirection.json: |
        { 
          "redirections": [
            {"source_path": "a.md", "redirect_url": "/aa"}, 
            {"source_path": "b.md", "redirect_url": "/bb"}]
        }
      .openpublishing.redirection.test.json: |
        {
          "redirections": [{"source_path": "c.md", "redirect_url": "/cc"}]
        }
      a/docfx.yml:
      a/.openpublishing.redirection.test.json: |
        {
           "redirections": [
            {"source_path": "a.md", "redirect_url": "/aa"}, 
            {"source_path": "b.md", "redirect_url": "/bb"}]
        }
      a/b/.openpublishing.redirection.json: |
        {
          "redirections": [
            {"source_path": "a.md", "redirect_url": "/aa"}, 
            {"source_path": "b.md", "redirect_url": "/bb"}]
        }
outputs:
  a/.publish.json: |
    {
      "files": [
        {"url": "/a", "locale": "en-us", "redirect_url": "/aa"},
        {"url": "/b", "locale": "en-us", "redirect_url": "/bb"},
        {"url": "/b/a", "locale": "en-us", "redirect_url": "/aa"},
        {"url": "/b/b", "locale": "en-us", "redirect_url": "/bb"}
      ]
    }
---
# Multiple Redirection Files with source_path_from_root
repos:
  https://github.com/redirection/multiple-redirection-files-source-path-from-root:
  - files:
      .openpublishing.publish.config.json: |
        {
          "docsets_to_publish": [{"build_source_folder":"a"}],
          "redirection_files": [
            ".openpublishing.redirection.json",
            "a/b/.openpublishing.redirection.json"
          ],
        }
      .openpublishing.redirection.json: |
        {
          "redirections": [
            {"source_path": "a/a.md", "redirect_url": "/aa"}, 
            {"source_path": "b.md", "redirect_url": "/bb"}]
        }
      a/docfx.yml:
      a/b/.openpublishing.redirection.json: |
        {"redirections": [{"source_path_from_root": "/a/c.md", "redirect_url": "/aa"}]}
outputs:
  a/.publish.json: |
    {
      "files": [
        {"url": "/a", "locale": "en-us", "redirect_url": "/aa"},
        {"url": "/c", "locale": "en-us", "redirect_url": "/aa"}
      ]
    }
---
# Multiple Redirection Files with redirect url conflict
repos:
  https://github.com/redirection/multiple-redirection-files-source-path-from-root:
  - files:
      .openpublishing.publish.config.json: |
        {
          "docsets_to_publish": [{"build_source_folder":"a"}],
          "redirection_files": [
            ".openpublishing.redirection.json",
            "a/b/.openpublishing.redirection.json"
          ],
        }
      .openpublishing.redirection.json: |
        {
          "redirections": [{"source_path": "a/a.md", "redirect_url": "/aa", "redirect_document_id": true}]
        }
      a/docfx.yml:
      a/b/.openpublishing.redirection.json: |
        {"redirections": [{"source_path_from_root": "/a/b.md", "redirect_url": "/aa", "redirect_document_id": true}]}
      a/aa.md:
outputs:
  a/.publish.json: |
    {
      "files": [
        {"url": "/a", "locale": "en-us", "redirect_url": "/aa"},
        {"url": "/b", "locale": "en-us"},
        {"url": "/aa", "locale": "en-us"}
      ]
    }
  .errors.log: |
    {"message_severity":"warning","code":"redirection-url-conflict","message":"The following files are redirected to '/aa' with redirect_document_id set to true: 'a.md', 'b.md'. Only one file can have its document ID redirected to each redirect_url. Change all but one instance to false in redirection file(s): '../.openpublishing.redirection.json', 'b/.openpublishing.redirection.json'.","file":".openpublishing.redirection.json","line":2,"column":66}
  a/aa.json:
---
# File not found for a registered redirection file.
repos:
  https://github.com/redirection/multiple-redirection-files-file-not-found:
  - files:
      .openpublishing.publish.config.json: |
        {
          "docsets_to_publish": [{"build_source_folder":"a"}],
          "redirection_files": [
            "a/b/.openpublishing.redirection.json"
          ],
        }
      a/docfx.yml:
outputs:
  .errors.log: |
    {"message_severity":"error","code":"redirection-file-not-found","message":"Redirection file 'a/b/.openpublishing.redirection.json' registered in .openpublishing.publish.json is not found in the repo."}
---
# source_path and source_path_from_root exist at the same time
repos:
  https://github.com/redirection/two-path-at-the-same-time:
  - files:
      .openpublishing.publish.config.json: |
        {
          "docsets_to_publish": [{"build_source_folder":"a"}],
          "redirection_files": [
            "a/b/.openpublishing.redirection.json"
          ],
        }
      a/docfx.yml:
      a/b/.openpublishing.redirection.json: |
        {"redirections": [{"source_path": "c.md", "source_path_from_root": "/a/c.md", "redirect_url": "/aa"}]}
outputs:
  a/.publish.json:
  .errors.log: |
    {"message_severity":"error","code":"source-path-conflict","message":"A redirection item cannot contain 'source_path' and 'source_path_from_root' at the same time.","file":"a/b/.openpublishing.redirection.json","line":1,"column":99}
---
# redirection conflicts for multiple redirection files
repos:
  https://github.com/redirection/multiple-redirection-files-redirection-conflict:
  - files:
      .openpublishing.publish.config.json: |
        {
          "docsets_to_publish": [{"build_source_folder":"a"}],
          "redirection_files": [
            ".openpublishing.redirection.json",
            "a/b/.openpublishing.redirection.json"
          ],
        }
      .openpublishing.redirection.json: |
        {
          "redirections": [{"source_path": "a/a.md", "redirect_url": "/aa"}]
        }
      a/docfx.yml:
      a/b/.openpublishing.redirection.json: |
        {"redirections": 
          [{"source_path_from_root": "/a/a.md", "redirect_url": "/aa"}]
        }
outputs:
  a/.publish.json:
  .errors.log: |
    {"message_severity":"error","code":"redirection-conflict","message":"The 'a.md' appears twice or more in the redirection mappings.","file":"a/b/.openpublishing.redirection.json","line":2,"column":61}
---
# redirection syntax check
repos:
  https://github.com/redirection/multiple-redirection-files-redirection-syntax-check:
  - files:
      .openpublishing.publish.config.json: |
        {
          "docsets_to_publish": [{"build_source_folder":"a"}],
          "redirection_files": [
            ".openpublishing.redirection.json",
            "a/b/.openpublishing.redirection.json"
          ],
        }
      .openpublishing.redirection.json: |
        {
          "redirections": [{"source_path": "/a/a.md", "redirect_url": "/aa"}]
        }
      a/docfx.yml:
      a/b/.openpublishing.redirection.json: |
        {"redirections": 
          [{"source_path_from_root": "a/a.md", "redirect_url": "/aa"}]
        }
outputs:
  a/.publish.json:
  .errors.log: |
    {"message_severity":"warning","code":"redirection-path-syntax-error","message":"Redirection path syntax is incorrect. 'source_path' should start without '/' and 'source_path_from_root' should start with '/'.","file":".openpublishing.redirection.json","line":2,"column":67}
    {"message_severity":"warning","code":"redirection-path-syntax-error","message":"Redirection path syntax is incorrect. 'source_path' should start without '/' and 'source_path_from_root' should start with '/'.","file":"a/b/.openpublishing.redirection.json","line":2,"end_column":60}
---
# case insensitive for redirection_files on windows/mac
os: windows, mac
repos:
  https://github.com/redirection/case-insensitive-redirection-files:
  - files:
      .openpublishing.publish.config.json: |
        {
          "docsets_to_publish": [{"build_source_folder":"a"}],
          "redirection_files": [
            "a/b/.openpublishing.redirection.a.json",
            "a/b/.openpublishing.redirection.A.json"
            ]
        }
      a/docfx.yml:
      a/b/.openpublishing.redirection.A.json: |
        {"redirections": [{"source_path_from_root": "/a/c.md", "redirect_url": "/aa"}]}
outputs:
  a/.publish.json: |
    {"files": [{"url": "/c", "locale": "en-us", "redirect_url": "/aa"}]}
---
# case sensitive for redirection_files on linux
os: linux
repos:
  https://github.com/redirection/case-sensitive-redirection-files:
  - files:
      .openpublishing.publish.config.json: |
        {
          "docsets_to_publish": [{"build_source_folder":"a"}],
          "redirection_files": [
            "a/b/.openpublishing.redirection.a.json",
            "a/b/.openpublishing.redirection.A.json"
            ]
        }
      a/docfx.yml:
      a/b/.openpublishing.redirection.A.json: |
        {"redirections": [{"source_path_from_root": "/a/c.md", "redirect_url": "/aa"}]}
outputs:
  .errors.log: |
    {"message_severity":"error","code":"redirection-file-not-found","message":"Redirection file 'a/b/.openpublishing.redirection.a.json' registered in .openpublishing.publish.json is not found in the repo."}
  a/.publish.json: |
    {"files": [{"url": "/c", "locale": "en-us", "redirect_url": "/aa"}]}
---
# redirection source path contains invalid path char
os: windows
repos:
  https://github.com/redirection/invalid-redirection-source-path:
  - files:
      docfx.yml:
      .openpublishing.redirection.json: |
        {"redirections": [{"source_path": "<invalid>/*invalid.md", "redirect_url": "/invalid"}]}
outputs:
  .errors.log: |
    {"message_severity":"warning","code":"path-invalid","message":"Path <invalid>/*invalid.md contains invalid chars '<', '>', '*'."}
    {"message_severity":"warning","code":"missing-attribute","message":"Missing required attribute: '(source_path or source_path_from_root) or redirect_url'."}
