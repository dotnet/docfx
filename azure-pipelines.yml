trigger:
  batch: true
  branches:
    include:
    - v3
    - v3-release
    - feature/*
pr:
- v3
- feature/*
jobs:

# Test pull requests on linux and mac
- job: LinuxBuild
  pool:
    vmImage: 'ubuntu-16.04'
  condition: eq(variables['Build.Reason'], 'PullRequest')
  steps:
    - bash: ./build.sh

- job: MaxBuild
  pool:
    vmImage: 'macOS-10.13'
  condition: eq(variables['Build.Reason'], 'PullRequest')
  steps:
    - bash: ./build.sh

# Test and deploy on windows
- job: WindowsBuild
  pool:
    vmImage: 'vs2017-win2016'
  steps:

  # Build and test
  - powershell: ./build.ps1
    displayName: Build
    env:
      GITHUB_BASIC_AUTH: $(GitHubBasicAuth)
      SYSTEM_ACCESS_TOKEN: $(System.AccessToken)
      GITHUB_ACCESS_TOKEN: $(GitHubAccessToken)

  # Publish code coverage results
  - task: PublishCodeCoverageResults@1
    inputs:
      codeCoverageTool: 'cobertura'
      summaryFileLocation: '**/coverage.cobertura.xml'
      reportDirectory: '**/TestResults/cobertura'
      failIfCoverageEmpty: true

  # Push to sandbox MyGet feed
  - task: NuGetCommand@2
    condition: and(succeeded(), ne(variables['Build.SourceBranch'], 'refs/heads/v3-release'))
    displayName: Push to Sandbox MyGet Feed
    inputs:
      command: push
      packagesToPush: drop/**/*.nupkg
      nuGetFeedType: external
      publishFeedCredentials: myget.docfx-v3-sandbox

  # Push to production MyGet feed
  - task: NuGetCommand@2
    condition: and(succeeded(), eq(variables['Build.SourceBranch'], 'refs/heads/v3-release'))
    displayName: Push to Production MyGet Feed
    inputs:
      command: push
      packagesToPush: drop/**/*.nupkg
      nuGetFeedType: external
      publishFeedCredentials: myget.docfx-v3
