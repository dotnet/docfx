parameters:
- name: repos
  type: object
  default:
    azure-docs-pr:
      params: https://github.com/MicrosoftDocs/azure-docs-pr --profile --timeout 100 --regression-rules
      branch: master
    sql-docs-pr:
      params: https://github.com/MicrosoftDocs/sql-docs-pr --profile --timeout 120 --regression-rules
      branch: master
    docs:
      params: https://github.com/dotnet/docs --timeout 60 --regression-rules
      branch: main
    learn-pr:
      params: https://github.com/MicrosoftDocs/learn-pr --timeout 100 --no-dry-sync --regression-rules
      branch: master
    windowsserverdocs-pr:
      params: https://github.com/MicrosoftDocs/windowsserverdocs-pr  --timeout 45 --regression-rules
      branch: master
    VBA-Docs:
      params: https://github.com/MicrosoftDocs/VBA-Docs --timeout 60 --regression-rules
      branch: master
    azure-devops-docs-pr:
      params: https://github.com/MicrosoftDocs/azure-devops-docs-pr --timeout 30 --regression-rules
      branch: master
    AspNetCore.Docs:
      params: https://github.com/dotnet/AspNetCore.Docs --profile --timeout 30 --output-html
      branch: main
    microsoft-365-docs-pr.zh-CN:
      params: https://github.com/MicrosoftDocs/microsoft-365-docs-pr.zh-CN --branch live-sxs --profile --timeout 25
      branch: live-sxs
    powerbi-docs-pr.de-DE:
      params: https://github.com/MicrosoftDocs/powerbi-docs-pr.de-DE --branch live-sxs --timeout 25
      branch: live-sxs
    PowerShell-Docs:
      params: https://github.com/MicrosoftDocs/PowerShell-Docs --timeout 75 --branch staging
      branch: staging
    roslyn-api-docs:
      params: https://github.com/dotnet/roslyn-api-docs --branch live --profile --timeout 105
      branch: live
    azure-docs-rest-apis:
      params: https://github.com/Azure/azure-docs-rest-apis --timeout 130 --error-level Warning
      branch: master
    dynamics365-docs-odata-apis:
      params: https://github.com/MicrosoftDocs/dynamics365-docs-odata-apis --timeout 20
      branch: master
    mc-docs-pr:
      params: https://github.com/MicrosoftDocs/mc-docs-pr --timeout 70
      branch: master
    dynamics365smb-devitpro:
      params: https://github.com/MicrosoftDocs/dynamics365smb-devitpro --timeout 15
      branch: master
    DevSandbox:
      params: https://github.com/MicrosoftDocs/DevSandbox --timeout 30
      branch: master
    test:
      params: https://github.com/MicrosoftDocs/test --timeout 20 --no-dry-sync
      branch: master
    DocsRoot:
      params: https://github.com/MicrosoftDocs/DocsRoot --timeout 20
      branch: master
    windows-compatibility:
      params: https://dev.azure.com/cpubwin/windows-compatibility/_git/windows-compatibility --timeout 20
      branch: main
    azure-docs-cli:
      params: https://github.com/MicrosoftDocs/azure-docs-cli --timeout 50
      branch: master
    dataprep-dotnet-pr:
      params: https://github.com/MicrosoftDocs/dataprep-dotnet-pr --timeout 30
      branch: master
    azure-mediaplayer-typescript:
      params: https://github.com/MicrosoftDocs/azure-mediaplayer-typescript --timeout 30
      branch: master
    quantum-docs-private:
      params: https://github.com/MicrosoftDocs/quantum-docs-private --timeout 30 --branch master
      branch: main
    microsoft-graph-docs:
      params: https://github.com/microsoftgraph/microsoft-graph-docs --timeout 30
      branch: main
    # dry-runs
    dryrun.bot-docs-pr:
      params: https://github.com/MicrosoftDocs/bot-docs-pr --timeout 40 --no-dry-sync --dry-run --public-template
      branch: master
    dryrun.azure-docs-pr:
      params: https://github.com/MicrosoftDocs/azure-docs-pr --profile --timeout 50 --dry-run --regression-rules
      branch: master

trigger:
  batch: true
  branches:
    include:
    - v3
    - v3-release
pr:
- v3

variables:
- group: devresourcekeyvault
- name: dotnetVersion
  value: 5.0.200
- name: runCodesignValidationInjection
  value: false
- name: NugetSecurityAnalysisWarningLevel
  value: none
- name: pipeline-option
  value: regression-test

jobs:

# Test and deploy on windows
- job: WindowsBuild
  pool:
    vmImage: 'windows-latest'
  steps:

  # Install .NET Core sdk
  - task: UseDotNet@2
    displayName: 'Install .NET Core sdk $(dotnetVersion)'
    inputs:
      packageType: sdk
      version: $(dotnetVersion)

  # dotnet test
  - task: DotNetCoreCLI@2
    displayName: dotnet test
    condition: and(succeeded(), eq(variables['pipeline-option'], 'regression-test-test'))
    inputs:
      command: test
      arguments:  -warnAsError -c Release /p:CollectCoverage=true /p:CoverletOutputFormat=cobertura
      publishTestResults: true
    env:
      DOCS_GITHUB_TOKEN: $(gitHubTestToken)
      DOCS_OPS_TOKEN: $(opBuildUserToken)
      MICROSOFT_GRAPH_CLIENT_CERTIFICATE: $(test-MS-Graph-Client-Cert)

  - task: reportgenerator@4
    displayName: Merge Test Results
    condition: and(succeeded(), eq(variables['pipeline-option'], 'regression-test-test'))
    inputs:
      reports: test/**/coverage.cobertura.xml
      targetdir: $(Pipeline.Workspace)/coveragereport

  - task: PublishCodeCoverageResults@1
    displayName: Upload Code Coverage Result
    inputs:
      codeCoverageTool: cobertura
      summaryFileLocation: $(Pipeline.Workspace)/coveragereport/Cobertura.xml

  # Build RegressionTest into Artifact 
  - powershell: |
      dotnet build ./test/docfx.RegressionTest -warnAsError -c Release -r win7-x64 -o ./drop/RegressionTest
    displayName: Build RegressionTest into Artifact 

  # Publish RegressionTest binary
  - publish: ./drop/RegressionTest
    displayName: Publish RegressionTest binary
    artifact: RegressionTest

  # Run Component Detection
  - task: ms.vss-governance-buildtask.governance-build-task-component-detection.ComponentGovernanceComponentDetection@0
    displayName: 'Component Detection'
    condition: and(succeeded(), ne(variables['Build.Reason'], 'PullRequest'))

# Run RegressionTest
- job: RunRegressionTest
  condition: and(succeeded(), ne(variables['Build.SourceBranch'], 'refs/heads/v3-release'))
  dependsOn: WindowsBuild
  pool:
    name: Docfx-1ES
  strategy:
    matrix:
      ${{ each repo in parameters.repos }}:
        ${{ repo.key }}:
          params: ${{repo.value.params}}

  steps:
  # Install .NET Core sdk
  - task: UseDotNet@2
    displayName: 'Install .NET Core sdk $(dotnetVersion)'
    inputs:
      packageType: sdk
      version: $(dotnetVersion)

  # Download RegressionTest binary
  - download: current
    displayName: Download RegressionTest binary
    artifact: RegressionTest

  # Install dotnet-trace
  - script: dotnet tool update -g dotnet-trace
    displayName: Install dotnet-trace

  # Run Regression Tests
  - task: AzureCLI@2
    displayName: Run
    inputs:
      azureSubscription: 'DevRel - Build Agents - 68db5a04-b547-4cfb-a966-6668a3bb3f7c'
      scriptType: ps
      scriptLocation: inlineScript
      powerShellErrorActionPreference: continue
      inlineScript: |
        echo $(params)
        $(Pipeline.Workspace)/RegressionTest/docfx.RegressionTest.exe $(params)
    env:
      BUILD_REASON: $(Build.Reason)
      DOCFX_APPDATA_PATH: D:/appdata
      DOCS_GITHUB_TOKEN: $(gitHubTestToken)
      DOCS_KV_PROD_ENDPOINT: https://docfxcikvpub.vault.azure.net/
      AZURE_DEVOPS_TOKEN: $(vsoTestToken)
      PULL_REQUEST_NUMBER : $(System.PullRequest.PullRequestNumber)
      APPINSIGHTS_INSTRUMENTATIONKEY: 5226e0d0-086f-4cab-a491-1d00fde9eb09

