trigger:
  batch: true
  branches:
    include:
    - v3
    - v3-release
pr:
- v3
variables:
  dotnetSdkVersion: 5.0.x
  dotnetRuntimeVersion: 3.1.x
  runCodesignValidationInjection: false

jobs:

- job: MacBuild
  pool:
    vmImage: 'macOS-latest'
  condition: eq(variables['Build.Reason'], 'PullRequest')
  steps:

  # Install .NET sdk
  - task: UseDotNet@2
    displayName: 'Install .NET SDK $(dotnetSdkVersion)'
    inputs:
      packageType: sdk
      version: $(dotnetSdkVersion)

  # Install .NET runtime
  - task: UseDotNet@2
    displayName: 'Install .NET Runtime $(dotnetRuntimeVersion)'
    inputs:
      packageType: runtime
      version: $(dotnetRuntimeVersion)

  - script: dotnet --info

  # dotnet build
  - task: DotNetCoreCLI@2
    displayName: dotnet build
    inputs:
      command: build
      arguments: -c Release

  # dotnet test
  - task: DotNetCoreCLI@2
    displayName: dotnet test
    inputs:
      command: test
      arguments: -c Release /p:CollectCoverage=true /p:CoverletOutputFormat=opencover"
      publishTestResults: true
    env:
      AZURE_DEVOPS_TOKEN: $(AZURE_DEVOPS_TOKEN)
      DOCS_GITHUB_TOKEN: $(DOCS_GITHUB_TOKEN)
      DOCS_OPS_TOKEN: $(DOCS_OPS_TOKEN)
      MICROSOFT_GRAPH_CLIENT_SECRET: $(MICROSOFT_GRAPH_CLIENT_SECRET)
      GIT_TOKEN_HTTP_AUTH_SSO_DISABLED: $(GIT_TOKEN_HTTP_AUTH_SSO_DISABLED)
      GIT_TOKEN_HTTP_AUTH_INSUFFICIENT_PERMISSION: $(GIT_TOKEN_HTTP_AUTH_INSUFFICIENT_PERMISSION)
